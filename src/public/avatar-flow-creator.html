<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar & Flow Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ReactFlow for live preview -->
    <script src="https://cdn.jsdelivr.net/npm/reactflow@11.10.1/dist/umd/index.js"></script>

    <!-- ZoomableFlowEditor Component for live preview -->
    <script src="components/ZoomableFlowEditor.js?v=1737286301"></script>
    <script src="components/ZoomableFlowCreator.js?v=1737287000"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }

        .creator-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .creator-header {
            background: #000;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-nav-buttons {
            display: flex;
            gap: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .creator-tabs {
            display: flex;
            gap: 10px;
        }

        .creator-title {
            font-size: 24px;
            color: #39e575;
            font-weight: 600;
        }

        .tab-btn {
            background: rgba(0, 0, 0, 0.8) !important;
            color: #fff !important;
            border: 1px solid rgba(57, 229, 117, 0.3) !important;
            padding: 12px 24px !important;
            border-radius: 0 !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            transition: all 0.3s !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #39e575, #2dd866) !important;
            color: #000 !important;
            border-color: #39e575 !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.4) !important;
        }

        .tab-btn:hover {
            border-color: #39e575 !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.2) !important;
            transform: translateY(-2px) !important;
        }

        .tab-btn.active:hover {
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.6) !important;
            background: linear-gradient(135deg, #2dd866, #39e575) !important;
        }

        .creator-body {
            flex: 1;
            overflow-y: auto;
        }

        .form-panel {
            width: 100%;
            padding: 20px;
            background: #000;
            background-image: linear-gradient(rgba(57, 229, 117, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(57, 229, 117, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        /* Avatar Selection Styles */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .avatar-card {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(57, 229, 117, 0.3);
            border-radius: 0;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .avatar-card:hover {
            border-color: #39e575;
            box-shadow: 0 20px 40px rgba(57, 229, 117, 0.3);
            transform: translateY(-5px);
        }

        .avatar-card.selected {
            border-color: #39e575;
            background: rgba(57, 229, 117, 0.1);
            box-shadow: 0 20px 40px rgba(57, 229, 117, 0.4);
        }

        .avatar-name {
            font-size: 16px;
            font-weight: 600;
            color: #39e575;
            margin-bottom: 8px;
        }

        .avatar-desc {
            font-size: 14px;
            color: #d1d5db;
            margin-bottom: 8px;
        }

        .avatar-specialization {
            font-size: 12px;
            color: #8b949e;
            font-style: italic;
        }

        .divider {
            text-align: center;
            margin: 32px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #3a3a3a;
        }

        .divider span {
            background: #1a1a1a;
            padding: 0 16px;
            color: #8b949e;
            font-weight: 600;
        }

        .loading-state, .empty-state {
            text-align: center;
            padding: 32px;
            color: #8b949e;
            font-style: italic;
        }

        /* Warning Section */
        .warning-section {
            background: #2a1f1f;
            border: 2px solid #d73a49;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
        }

        .warning-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .warning-text h3 {
            color: #f85149;
            margin-bottom: 8px;
            font-size: 20px;
        }

        .warning-text p {
            color: #d1d5db;
            font-size: 14px;
        }

        /* Selected Avatar Info */
        .selected-avatar-info {
            background: #1a2e1a;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .selected-avatar-name {
            font-size: 18px;
            font-weight: 600;
            color: #40c463;
            margin-bottom: 8px;
        }

        .selected-avatar-desc {
            font-size: 14px;
            color: #d1d5db;
        }

        /* Flow graph styles (copied from dashboard) */
        .flow-graph {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 16px;
        }

        /* FORCE ReactFlow nodes to use absolute positioning */
        .flow-graph .react-flow__node {
            position: absolute !important;
            display: block !important;
            width: auto !important;
            height: auto !important;
        }

        .flow-graph .react-flow__node-cardNode {
            position: absolute !important;
            display: inline-block !important;
            width: 260px !important;
            height: auto !important;
        }

        /* Flows Manager Styles */
        .flows-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .flow-item {
            background: #2a2a2a;
            border: 2px solid #3a3a3a;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flow-item:hover {
            border-color: #58a6ff;
            background: #333;
        }

        .flow-item.selected {
            border-color: #28a745;
            background: #1a4a2a;
        }

        .flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .flow-name {
            font-size: 16px;
            font-weight: 600;
            color: #58a6ff;
        }

        .flow-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-edit {
            background: linear-gradient(135deg, #39e575, #2dd866);
            color: #000;
            box-shadow: 0 2px 8px rgba(57, 229, 117, 0.3);
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #2dd866, #39e575);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(57, 229, 117, 0.5);
        }

        .btn-danger {
            background: rgba(220, 38, 38, 0.8);
            color: white;
            border: 1px solid rgba(220, 38, 38, 0.5);
        }

        .btn-danger:hover {
            background: rgba(185, 28, 28, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        .flow-description {
            font-size: 14px;
            color: #d1d5db;
            margin-bottom: 8px;
        }

        .flow-stats {
            font-size: 12px;
            color: #8b949e;
            font-style: italic;
        }

        .form-section {
            background: #3a3a3a;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #4a4a4a;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #4a4a4a;
            gap: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #58a6ff;
            flex: 1;
            min-width: 0;
        }

        .ai-generate-btn {
            background: linear-gradient(135deg, #39e575, #2dd866) !important;
            color: #000 !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 0 !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            transition: all 0.3s !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.4) !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            min-width: 140px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .ai-generate-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.6) !important;
            background: linear-gradient(135deg, #2dd866, #39e575) !important;
        }

        /* Live Flow Preview Styles - minimalne zmiany */

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #e1e5e9;
            font-size: 15px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: #2a2a2a;
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            color: #e1e5e9;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
            appearance: none;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #39e575, #2dd866);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.4);
        }

        .btn:hover {
            background: linear-gradient(135deg, #2dd866, #39e575);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #39e575, #2dd866);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #2dd866, #39e575);
        }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 1px solid rgba(57, 229, 117, 0.3);
        }

        .btn-secondary:hover {
            border-color: #39e575;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.2);
        }

        .btn:disabled {
            background: rgba(108, 117, 125, 0.8) !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled:hover {
            background: rgba(108, 117, 125, 0.8) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 18px;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem !important;
            background: linear-gradient(135deg, #39e575, #2dd866) !important;
            border: none !important;
            border-radius: 0 !important;
            color: #000 !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.4) !important;
            font-size: 0.875rem !important;
            margin: 0 2px !important;
        }

        /* Specjalne style dla tabów w creator-tabs */
        .creator-tabs .nav-btn {
            padding: 8px 16px !important;
            font-size: 14px !important;
            min-width: 120px !important;
            margin: 0 4px !important;
            background: rgba(0, 0, 0, 0.8) !important;
            color: #fff !important;
            border: 1px solid rgba(57, 229, 117, 0.3) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
        }

        .creator-tabs .nav-btn:hover {
            border-color: #39e575 !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.2) !important;
            background: rgba(57, 229, 117, 0.1) !important;
        }

        .nav-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.6) !important;
            background: linear-gradient(135deg, #2dd866, #39e575) !important;
        }

        .nav-btn:disabled {
            background: rgba(108, 117, 125, 0.8) !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .nav-btn:disabled:hover {
            background: rgba(108, 117, 125, 0.8) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .creator-tabs .nav-btn.active {
            background: linear-gradient(135deg, #39e575, #2dd866) !important;
            color: #000 !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.6) !important;
            transform: translateY(-2px) !important;
            border-color: #39e575 !important;
        }

        .creator-tabs .nav-btn.active:hover {
            background: linear-gradient(135deg, #2dd866, #39e575) !important;
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.8) !important;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #39e575, #2dd866) !important;
            color: #000 !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.6) !important;
            transform: translateY(-2px) !important;
        }

        .nav-btn.active:hover {
            background: linear-gradient(135deg, #2dd866, #39e575) !important;
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.8) !important;
        }

        /* Specjalny styl dla przycisku Zapisz Avatar */
        .creator-header .nav-btn {
            padding: 8px 16px !important;
            background: linear-gradient(135deg, #39e575, #2dd866) !important;
            border: none !important;
            border-radius: 0 !important;
            color: #000 !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.4) !important;
            font-size: 0.875rem !important;
            margin: 0 !important;
            min-width: auto !important;
        }

        .creator-header .nav-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.6) !important;
            background: linear-gradient(135deg, #2dd866, #39e575) !important;
        }

        .creator-header .nav-btn:disabled {
            background: rgba(108, 117, 125, 0.8) !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .creator-header .nav-btn:disabled:hover {
            background: rgba(108, 117, 125, 0.8) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Style formularzy */
        input, textarea, select {
            background: rgba(0, 0, 0, 0.8) !important;
            border: 1px solid rgba(57, 229, 117, 0.3) !important;
            border-radius: 0 !important;
            color: #fff !important;
            padding: 12px !important;
            font-family: 'Inter', sans-serif !important;
            font-size: 14px !important;
            transition: all 0.3s ease !important;
        }

        input:focus, textarea:focus, select:focus {
            outline: none !important;
            border-color: #39e575 !important;
            box-shadow: 0 0 0 2px rgba(57, 229, 117, 0.2) !important;
            background: rgba(0, 0, 0, 0.9) !important;
        }

        input::placeholder, textarea::placeholder {
            color: #888 !important;
        }

        /* Style dla przycisków generuj */
        .generate-btn, button[onclick*="generate"] {
            background: linear-gradient(135deg, #39e575, #2dd866) !important;
            border: none !important;
            border-radius: 0 !important;
            color: #000 !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.4) !important;
            padding: 8px 16px !important;
            font-size: 14px !important;
        }

        .generate-btn:hover, button[onclick*="generate"]:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(57, 229, 117, 0.6) !important;
            background: linear-gradient(135deg, #2dd866, #39e575) !important;
        }

        .preview-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 0;
            margin-bottom: 20px;
            border: 1px solid rgba(57, 229, 117, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            color: #39e575;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-content {
            background: #111;
            background-image: linear-gradient(rgba(57, 229, 117, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(57, 229, 117, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            padding: 15px;
            border-radius: 0;
            border: 1px solid rgba(57, 229, 117, 0.3);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            line-height: 1.5;
            color: #fff;
            white-space: pre-wrap;
            position: relative;
            overflow: hidden;
            height: 500px; /* Wysokość dla ReactFlow */
        }

        .keyword-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .keyword-tag {
            display: inline-block;
            background: #39e575;
            color: #000;
            padding: 4px 10px;
            border-radius: 0;
            font-size: 12px;
            margin: 2px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .keyword-tag:hover {
            background: #2dd866;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(57, 229, 117, 0.4);
        }

        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #4a4a4a;
            min-height: 50px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 15px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3a3a3a;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active {
            background: #39e575;
            color: #000;
            box-shadow: 0 4px 15px rgba(57, 229, 117, 0.4);
        }

        .step.completed {
            background: #39e575;
            color: #000;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #3a3a3a;
            border-radius: 50%;
            border-top-color: #39e575;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
        }

        .flow-step {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #4a4a4a;
        }

        .flow-step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .flow-step-title {
            font-weight: 600;
            color: #39e575;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .remove-step-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .knowledge-upload-area {
            border: 2px dashed #4a4a4a;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #2a2a2a;
            margin: 15px 0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .knowledge-upload-area:hover {
            border-color: #58a6ff;
            background: #333;
        }

        .knowledge-upload-area.dragover {
            border-color: #58a6ff;
            background: #1a3a5c;
        }

        .file-input {
            display: none;
        }

        .uploaded-files {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #3a3a3a;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 5px 0;
            border: 1px solid #4a4a4a;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            font-size: 16px;
        }

        .file-name {
            font-weight: 500;
            color: #e1e5e9;
        }

        .file-size {
            font-size: 12px;
            color: #7d8590;
        }

        .remove-file-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .flow-visualization {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #3a3a3a;
        }

        .flow-step-node {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #58a6ff;
            position: relative;
        }

        .flow-step-node::after {
            content: '↓';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            color: #58a6ff;
            font-size: 20px;
            font-weight: bold;
        }

        .flow-step-node:last-child::after {
            display: none;
        }

        .add-step-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin: 10px 0;
            transition: all 0.3s;
        }

        .add-step-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        /* Reactive Avatars Styles */
        .prompt-editor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .prompt-editor-section {
            display: flex;
            flex-direction: column;
        }

        .prompt-textarea {
            min-height: 200px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            resize: vertical;
        }

        .avatar-meta {
            margin: 8px 0;
            font-size: 12px;
            color: #8b949e;
        }

        .avatar-position {
            font-weight: 500;
            color: #58a6ff;
        }

        .avatar-company {
            margin-top: 2px;
        }

        .avatar-personality {
            margin-top: 8px;
            font-size: 11px;
            color: #7c3aed;
            font-style: italic;
        }

        .avatar-status {
            margin-top: 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .save-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .save-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        /* Avatar Flow Count Badge */
        .avatar-flow-count {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #0ea5e9;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .avatar-flow-count.zero {
            background: #6b7280;
        }

        .avatar-flow-count.multiple {
            background: #10b981;
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const {useState, useEffect, useRef} = React;

    // API Service
    const CreatorAPI = {
        async saveAvatar(avatarData, flowData, intentData) {
            try {
                const response = await fetch('/api/avatar/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: avatarData.name,
                        description: avatarData.description,
                        personality: avatarData.personality,
                        specialization: avatarData.specialization,
                        communication_style: avatarData.communication_style,
                        background: avatarData.background,
                        knowledge_files: avatarData.knowledge_files,
                        flows: flowData.steps.length > 0 ? [{
                            id: flowData.id || `flow_${Date.now()}`,
                            name: flowData.name,
                            description: flowData.description,
                            steps: flowData.steps,
                            entry_intents: flowData.entry_intents || [],
                            priority: flowData.priority || 5,
                            success_criteria: [],
                            max_duration: 3600,
                            repeatable: true,
                            created_from: 'hybrid'
                        }] : [],
                        intents: intentData.name ? [{
                            name: intentData.name,
                            description: `Intent for ${avatarData.name}`,
                            keywords: intentData.keywords,
                            examples: intentData.examples,
                            requires_flow: true,
                            flow_name: flowData.name,
                            repeatable: true,
                            priority: 5,
                            system_prompt: intentData.system_prompt,
                            user_prompt_template: intentData.user_prompt_template,
                            confidence_threshold: intentData.confidence_threshold,
                            created_from: 'ai_generated'
                        }] : []
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error saving avatar:', error);
                throw error;
            }
        },
        async generateAvatarField(fieldName, description) {
            try {
                const response = await fetch('/api/flow-wizard/generate-avatar-field', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fieldName: fieldName,
                        description: description
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error generating avatar field:', error);

                // Fallback to mock data if API fails
                const mockResponses = {
                    name: "Prezes Firmy",
                    specialization: "Zarządzanie strategiczne, rozwój biznesu, leadership, transformacja cyfrowa, budowanie zespołów",
                    personality: "Charyzmatyczny, wizjonerski, pewny siebie, inspirujący innych, zorientowany na wyniki, empatyczny w kontaktach z zespołem",
                    communication_style: "Pewny siebie, motywujący, jasny w przekazie, słucha aktywnie, zadaje strategiczne pytania, inspiruje do działania",
                    background: "15-letnie doświadczenie w branży technologicznej, prowadził 3 startupy, zbudował zespoły ponad 200 osób, doświadczenie międzynarodowe w Europie i USA"
                };

                return {
                    success: true,
                    data: mockResponses[fieldName] || "Wygenerowana wartość (fallback)"
                };
            }
        },

        async generateFlowField(fieldName, avatarName, specialization) {
            await new Promise(resolve => setTimeout(resolve, 1000));

            const mockFlowResponses = {
                name: "Leadership & Vision Flow",
                description: "Flow dla prezesa - leadership i wizja strategiczna, budowanie relacji biznesowych i inspirowanie zespołu",
                steps: [
                    {
                        id: "strategic_greeting",
                        name: "Strategiczne powitanie",
                        description: "Powitanie z perspektywy lidera, nawiązanie kontaktu biznesowego"
                    },
                    {
                        id: "vision_sharing",
                        name: "Dzielenie się wizją",
                        description: "Prezentacja wizji i strategii firmy, inspirowanie rozmówcy"
                    },
                    {
                        id: "leadership_guidance",
                        name: "Wskazówki przywódcze",
                        description: "Udzielanie rad z pozycji lidera, coaching biznesowy"
                    },
                    {
                        id: "business_networking",
                        name: "Networking biznesowy",
                        description: "Budowanie relacji, poszukiwanie synergii biznesowych"
                    }
                ]
            };

            return {
                success: true,
                data: mockFlowResponses[fieldName] || "Wygenerowana wartość"
            };
        },

        async generateIntentField(fieldName, intentName, context) {
            await new Promise(resolve => setTimeout(resolve, 800));

            const mockIntentResponses = {
                name: "strategic_vision",
                keywords: ["strategia", "wizja", "przywództwo", "kierowanie", "liderowanie", "rozwój", "innowacje"],
                examples: [
                    "Opowiedz o swojej wizji firmy",
                    "Jak widzisz przyszłość naszej branży?",
                    "Jakie są twoje priorytety strategiczne?",
                    "Jak budujesz zespół?",
                    "Jakie wyzwania widzisz w leadership?"
                ],
                system_prompt: `Jesteś doświadczonym prezesem firmy z 15-letnim stażem w branży technologicznej. Odpowiadasz z perspektywy lidera, który ma jasną wizję i strategię. Twój styl to pewność siebie, inspirowanie innych i zorientowanie na wyniki. Prowadzisz rozmowy biznesowe z potencjalnymi partnerami i klientami.`,
                user_prompt_template: `Rozmówca pyta o: "{{user_message}}"

Jako doświadczony prezes firmy:
1. Odpowiedz z perspektywy strategicznej i wizjonerskiej
2. Pokaż swoją wiedzę i doświadczenie w leadership
3. Zainspiruj rozmówcę swoją pasją do biznesu
4. Zakończ pytaniem o jego cele biznesowe lub wyzwania
5. Utrzymaj profesjonalny, ale ciepły ton rozmowy

Historia rozmowy: {{conversation_history}}

Twoja odpowiedź:`
            };

            return {
                success: true,
                data: mockIntentResponses[fieldName] || "Wygenerowana wartość"
            };
        }
    };

    // Main Creator Component
    function AvatarFlowCreator() {
        const [activeTab, setActiveTab] = useState('avatar');
        const [currentStep, setCurrentStep] = useState(1);
        const [isGenerating, setIsGenerating] = useState(false);
        const [message, setMessage] = useState('');

        // Avatar Selection State
        const [selectedAvatar, setSelectedAvatar] = useState(null);
        const [existingAvatars, setExistingAvatars] = useState([]);
        const [isLoadingAvatars, setIsLoadingAvatars] = useState(false);
        const [showIntentModal, setShowIntentModal] = useState(false);

        // Flows Manager State
        const [selectedFlow, setSelectedFlow] = useState(null);
        const [editingFlow, setEditingFlow] = useState(null);

        // Reactive Avatars State
        const [reactiveAvatars, setReactiveAvatars] = useState([]);
        const [selectedReactiveAvatar, setSelectedReactiveAvatar] = useState(null);
        const [editingReactivePrompts, setEditingReactivePrompts] = useState({
            system_prompt: '',
            user_prompt_template: ''
        });

        // AI Generator State for Reactive Avatars
        const [showReactiveGenerator, setShowReactiveGenerator] = useState(false);
        const [reactiveGeneratorData, setReactiveGeneratorData] = useState({
            description: '',
            avatarType: 'client'
        });
        const [generatedReactiveAvatar, setGeneratedReactiveAvatar] = useState(null);

        // Company Profiles state
        const [companyProfiles, setCompanyProfiles] = useState({});
        const [selectedCompany, setSelectedCompany] = useState('aureus');
        const [editingCompanyProfile, setEditingCompanyProfile] = useState({
            company_context: '',
            your_role_description: '',
            current_situation: '',
            goals_objectives: '',
            key_challenges: ''
        });

        // Avatar Creator State
        const [avatarData, setAvatarData] = useState({
            name: '',
            description: '',
            personality: '',
            specialization: '',
            communication_style: '',
            background: '',
            knowledge_files: []
        });

        // Flow Creator State
        const [flowData, setFlowData] = useState({
            id: '',
            name: '',
            description: '',
            avatar_type: 'custom',
            steps: [],
            entry_intents: [],
            priority: 5
        });

        // Intent Creator State
        const [intentData, setIntentData] = useState({
            name: '',
            keywords: [],
            examples: [],
            system_prompt: '',
            user_prompt_template: '',
            confidence_threshold: 0.7
        });

        const [newKeyword, setNewKeyword] = useState('');
        const [newExample, setNewExample] = useState('');
        const [newStepName, setNewStepName] = useState('');
        const [newStepDescription, setNewStepDescription] = useState('');

        // Load existing avatars on component mount
        React.useEffect(() => {
            loadExistingAvatars();
            loadReactiveAvatars();
        }, []);

        const loadExistingAvatars = async () => {
            setIsLoadingAvatars(true);
            try {
                const response = await fetch('/api/avatars');
                if (response.ok) {
                    const result = await response.json();
                    console.log('🔍 [AVATAR API] Response:', result);
                    setExistingAvatars(result.data || result);
                }
            } catch (error) {
                console.error('Error loading avatars:', error);
                setMessage('❌ Błąd ładowania avatarów');
            } finally {
                setIsLoadingAvatars(false);
            }
        };

        const getDefaultSystemPrompt = (type, result) => {
            if (type === 'client') {
                return `Jesteś ${result.simulation_avatars[type].firstName} ${result.simulation_avatars[type].lastName}, ${result.simulation_avatars[type].position} w firmie ${result.simulation_avatars[type].company.name}.

TWOJA ROLA: buyer (klient)
OSOBOWOŚĆ: ${result.simulation_avatars[type].personality.style}
BRANŻA: ${result.simulation_avatars[type].company.industry}
WIELKOŚĆ FIRMY: ${result.simulation_avatars[type].company.size}

TWOJE CELE W ROZMOWIE:
- Znaleźć rozwiązanie problemów swojej firmy
- Upewnić się o wartości dla biznesu
- Sprawdzić czy to opłacalne rozwiązanie
- Zminimalizować ryzyko biznesowe

TWOJE WYZWANIA:
- Ograniczony budżet
- Potrzeba uzasadnienia decyzji przed kierownictwem
- Skeptycyzm wobec nowych rozwiązań
- Presja czasu na podejmowanie decyzji

JAKO BUYER:
- Zadawaj pytania o produkty/usługi
- Wyrażaj wątpliwości i obawy
- Negocjuj warunki
- Bądź skeptyczny ale konstruktywny
- Żądaj konkretnych przykładów i dowodów

Odpowiadaj w charakterze dla tej osoby, używając jej stylu komunikacji: ${result.simulation_avatars[type].personality.communication_style}`;
            } else {
                return `Jesteś ${result.simulation_avatars[type].firstName} ${result.simulation_avatars[type].lastName}, ${result.simulation_avatars[type].position} w firmie ${result.simulation_avatars[type].company.name}.

TWOJA ROLA: learner (uczeń)
OSOBOWOŚĆ: ${result.simulation_avatars[type].personality.style}
BRANŻA: ${result.simulation_avatars[type].company.industry}
POZIOM DOŚWIADCZENIA: ${result.simulation_avatars[type].experience_years} lat

TWOJE CELE W ROZMOWIE:
- Nauczyć się nowych umiejętności menedżerskich
- Zdobyć praktyczne narzędzia do pracy
- Rozwinąć kompetencje przywódcze
- Rozwiązać konkretne problemy w zespole

TWOJE WYZWANIA:
- Brak doświadczenia w zarządzaniu
- Niepewność w podejmowaniu decyzji
- Potrzeba budowania autorytetu w zespole
- Balansowanie między zadaniami technicznymi a menedżerskimi

JAKO LEARNER:
- Zadawaj pytania o wiedzę i umiejętności
- Proś o konkretne przykłady
- Dziel się swoimi wyzwaniami
- Bądź chętny do nauki
- Proś o feedback i wskazówki

Odpowiadaj w charakterze dla tej osoby, używając jej stylu komunikacji: ${result.simulation_avatars[type].personality.communication_style}`;
            }
        };

        const getDefaultUserPrompt = (type, result) => {
            return `Rozmówca napisał: "{{user_message}}"

Twoje zadanie jako ${type === 'client' ? 'KLIENT (buyer)' : 'UCZEŃ (learner)'}:
1. Odpowiedz w charakterze ${result.simulation_avatars[type].firstName} ${result.simulation_avatars[type].lastName}
2. ${type === 'client' ? 'Zachowuj się jak potencjalny klient szukający rozwiązań biznesowych' : 'Zachowuj się jak chętny do nauki menedżer z ograniczonym doświadczeniem'}
3. ${type === 'client' ? 'Zadawaj pytania o korzyści, koszty, implementation' : 'Zadawaj pytania o praktyczne zastosowania i przykłady'}
4. Używaj stylu: ${result.simulation_avatars[type].personality.communication_style}
5. Reaguj zgodnie z osobowością: ${result.simulation_avatars[type].personality.style}

PAMIĘTAJ: Jesteś ${type === 'client' ? 'skeptycznym ale zainteresowanym klientem' : 'ambitnym ale niepewnym uczniem'}.`;
        };

        const loadReactiveAvatars = async () => {
            try {
                // Load static reactive avatars from configuration
                const [avatarsResponse, promptsResponse] = await Promise.all([
                    fetch('/api/simulation-avatars'),
                    fetch('/api/reactive-avatars/prompts')
                ]);

                if (avatarsResponse.ok) {
                    const result = await avatarsResponse.json();
                    const savedPrompts = promptsResponse.ok ?
                        (await promptsResponse.json()).data || [] : [];

                    console.log('📝 Loaded saved prompts:', savedPrompts);

                    const reactiveTypes = ['client', 'student'];
                    const avatars = reactiveTypes.map(type => {
                        const savedPrompt = savedPrompts.find(p => p.avatar_id === type);

                        return {
                            id: type,
                            type: type,
                            name: result.simulation_avatars[type].firstName + ' ' + result.simulation_avatars[type].lastName,
                            position: result.simulation_avatars[type].position,
                            company: result.simulation_avatars[type].company.name,
                            personality: result.simulation_avatars[type].personality,
                            // Custom prompts (editable) with defaults
                            custom_prompts: {
                                system_prompt: savedPrompt?.system_prompt || getDefaultSystemPrompt(type, result),
                                user_prompt_template: savedPrompt?.user_prompt_template || getDefaultUserPrompt(type, result)
                            }
                        }
                    });
                    setReactiveAvatars(avatars);
                }
            } catch (error) {
                console.error('Error loading reactive avatars:', error);
                setMessage('❌ Błąd ładowania reaktywnych avatarów');
            }
        };

        // Generate specific Avatar field with AI
        const generateAvatarField = async (fieldName) => {
            if (!avatarData.description.trim()) {
                setMessage('Podaj najpierw opis avatara (dla AI)');
                return;
            }

            setIsGenerating(true);
            try {
                const result = await CreatorAPI.generateAvatarField(fieldName, avatarData.description);
                if (result.success) {
                    setAvatarData({...avatarData, [fieldName]: result.data});
                    setMessage(`✅ ${fieldName} wygenerowane!`);
                }
            } catch (error) {
                setMessage(`❌ Błąd generowania ${fieldName}`);
            } finally {
                setIsGenerating(false);
            }
        };

        // Generate specific Flow field with AI
        const generateFlowField = async (fieldName) => {
            if (!avatarData.name.trim()) {
                setMessage('Najpierw stwórz avatara');
                return;
            }

            setIsGenerating(true);
            try {
                const result = await CreatorAPI.generateFlowField(fieldName, avatarData.name, avatarData.specialization);
                if (result.success) {
                    setFlowData({...flowData, [fieldName]: result.data});
                    setMessage(`✅ ${fieldName} wygenerowane!`);
                }
            } catch (error) {
                setMessage(`❌ Błąd generowania ${fieldName}`);
            } finally {
                setIsGenerating(false);
            }
        };

        // Generate specific Intent field with AI
        const generateIntentField = async (fieldName) => {
            if (!intentData.name.trim() && fieldName !== 'name') {
                setMessage('Podaj najpierw nazwę intencji');
                return;
            }

            setIsGenerating(true);
            try {
                const result = await CreatorAPI.generateIntentField(fieldName, intentData.name, avatarData.specialization);
                if (result.success) {
                    if (fieldName === 'keywords' || fieldName === 'examples') {
                        setIntentData({...intentData, [fieldName]: result.data});
                    } else {
                        setIntentData({...intentData, [fieldName]: result.data});
                    }
                    setMessage(`✅ ${fieldName} wygenerowane!`);
                }
            } catch (error) {
                setMessage(`❌ Błąd generowania ${fieldName}`);
            } finally {
                setIsGenerating(false);
            }
        };

        // Generate new Reactive Avatar with AI
        const generateReactiveAvatar = async () => {
            if (!reactiveGeneratorData.description.trim()) {
                setMessage('Podaj opis reaktywnego avatara');
                return;
            }

            setIsGenerating(true);
            try {
                const response = await fetch('/api/reactive-avatars/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: reactiveGeneratorData.description,
                        avatarType: reactiveGeneratorData.avatarType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    setGeneratedReactiveAvatar(result.data);
                    setMessage(`✅ Wygenerowano reaktywny avatar: ${result.data.firstName} ${result.data.lastName}`);
                } else {
                    const error = await response.json();
                    setMessage(`❌ Błąd generowania avatara: ${error.error}`);
                }
            } catch (error) {
                console.error('Error generating reactive avatar:', error);
                setMessage('❌ Błąd podczas generowania reaktywnego avatara');
            } finally {
                setIsGenerating(false);
            }
        };

        // Add generated avatar to simulation-avatars.json
        const addGeneratedAvatarToSystem = async () => {
            if (!generatedReactiveAvatar) return;

            try {
                setIsGenerating(true);

                // Zapisz avatar do simulation-avatars.json
                const response = await fetch('/api/reactive-avatars/save-generated', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        avatarData: generatedReactiveAvatar
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Avatar saved successfully:', result);

                    // Reset generator state
                    const avatarName = `${generatedReactiveAvatar.firstName} ${generatedReactiveAvatar.lastName}`;
                    setGeneratedReactiveAvatar(null);
                    setReactiveGeneratorData({
                        description: '',
                        avatarType: 'client'
                    });
                    setShowReactiveGenerator(false);

                    // Reload reactive avatars to show new one
                    await loadReactiveAvatars();

                    setMessage(`✅ Avatar ${avatarName} dodany do systemu jako ${result.data.avatar_key}`);
                } else {
                    const error = await response.json();
                    setMessage(`❌ Błąd zapisywania avatara: ${error.error}`);
                }
            } catch (error) {
                console.error('Error adding avatar to system:', error);
                setMessage('❌ Błąd podczas dodawania avatara do systemu');
            } finally {
                setIsGenerating(false);
            }
        };

        // Add keyword
        const addKeyword = () => {
            if (newKeyword.trim() && !intentData.keywords.includes(newKeyword.trim())) {
                setIntentData({
                    ...intentData,
                    keywords: [...intentData.keywords, newKeyword.trim()]
                });
                setNewKeyword('');
            }
        };

        // Remove keyword
        const removeKeyword = (keyword) => {
            setIntentData({
                ...intentData,
                keywords: intentData.keywords.filter(k => k !== keyword)
            });
        };

        // Add example
        const addExample = () => {
            if (newExample.trim() && !intentData.examples.includes(newExample.trim())) {
                setIntentData({
                    ...intentData,
                    examples: [...intentData.examples, newExample.trim()]
                });
                setNewExample('');
            }
        };

        // Remove example
        const removeExample = (example) => {
            setIntentData({
                ...intentData,
                examples: intentData.examples.filter(e => e !== example)
            });
        };

        // File upload handlers
        const handleFileUpload = (files) => {
            const validTypes = ['application/pdf', 'text/csv', 'text/markdown', 'text/plain', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const maxSize = 10 * 1024 * 1024; // 10MB

            const validFiles = Array.from(files).filter(file => {
                if (!validTypes.includes(file.type) && !file.name.match(/\.(pdf|csv|md|txt|docx)$/i)) {
                    setMessage('❌ Nieprawidłowy typ pliku. Akceptowane: PDF, CSV, MD, TXT, DOCX');
                    return false;
                }
                if (file.size > maxSize) {
                    setMessage('❌ Plik za duży. Maksymalny rozmiar: 10MB');
                    return false;
                }
                return true;
            });

            if (validFiles.length > 0) {
                const newFiles = validFiles.map(file => ({
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                }));

                setAvatarData({
                    ...avatarData,
                    knowledge_files: [...avatarData.knowledge_files, ...newFiles]
                });

                setMessage(`✅ Dodano ${validFiles.length} plików`);
            }
        };

        const removeFile = (fileId) => {
            setAvatarData({
                ...avatarData,
                knowledge_files: avatarData.knowledge_files.filter(f => f.id !== fileId)
            });
        };

        const formatFileSize = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const getFileIcon = (fileName) => {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                pdf: '📄',
                csv: '📊',
                md: '📝',
                txt: '📝',
                docx: '📄'
            };
            return icons[ext] || '📄';
        };

        // Flow step handlers
        const addManualStep = () => {
            if (!newStepName.trim() || !newStepDescription.trim()) {
                setMessage('Podaj nazwę i opis kroku');
                return;
            }

            const newStep = {
                id: `manual_step_${Date.now()}`,
                name: newStepName.trim(),
                description: newStepDescription.trim(),
                required: true,
                next_steps: []
            };

            setFlowData({
                ...flowData,
                steps: [...flowData.steps, newStep]
            });

            setNewStepName('');
            setNewStepDescription('');
            setMessage('✅ Krok dodany!');
        };

        const removeStep = (stepId) => {
            setFlowData({
                ...flowData,
                steps: flowData.steps.filter(s => s.id !== stepId)
            });
        };

        // Save complete avatar
        const saveCompleteAvatar = async () => {
            if (!avatarData.name.trim()) {
                setMessage('❌ Nazwa avatara jest wymagana');
                return;
            }

            setIsGenerating(true);
            try {
                const result = await CreatorAPI.saveAvatar(avatarData, flowData, intentData);
                if (result.success) {
                    setMessage(`✅ Avatar "${result.data.name}" zapisany! ID: ${result.data.id}`);
                    console.log('✅ Saved avatar:', result.data);
                } else {
                    setMessage('❌ Błąd zapisywania avatara');
                }
            } catch (error) {
                console.error('Error saving avatar:', error);
                setMessage('❌ Błąd połączenia z API');
            } finally {
                setIsGenerating(false);
            }
        };

        // ============ COMPANY PROFILES FUNCTIONS ============

        const loadCompanyProfiles = async () => {
            try {
                const response = await fetch('/api/company-profiles');
                if (response.ok) {
                    const result = await response.json();
                    setCompanyProfiles(result.data || {});
                    console.log('🏢 Loaded company profiles:', result.data);
                }
            } catch (error) {
                console.error('Error loading company profiles:', error);
            }
        };

        const saveCompanyProfile = async () => {
            if (!selectedCompany || !editingCompanyProfile.company_context.trim()) {
                setMessage('⚠️ Wypełnij kontekst firmy');
                return;
            }

            try {
                const response = await fetch(`/api/company-profiles/${selectedCompany}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(editingCompanyProfile)
                });

                if (response.ok) {
                    setMessage('✅ Zapisano profil firmy');
                    await loadCompanyProfiles();
                } else {
                    setMessage('❌ Błąd podczas zapisu profilu firmy');
                }
            } catch (error) {
                console.error('Error saving company profile:', error);
                setMessage('❌ Błąd podczas zapisu profilu firmy');
            }
        };

        const selectCompanyForEdit = (companyId) => {
            setSelectedCompany(companyId);
            const savedProfile = companyProfiles[companyId];
            if (savedProfile) {
                setEditingCompanyProfile({
                    company_context: savedProfile.company_context || '',
                    your_role_description: savedProfile.your_role_description || '',
                    current_situation: savedProfile.current_situation || '',
                    goals_objectives: savedProfile.goals_objectives || '',
                    key_challenges: savedProfile.key_challenges || ''
                });
            } else {
                setEditingCompanyProfile({
                    company_context: getDefaultCompanyContext(companyId),
                    your_role_description: getDefaultRoleDescription(companyId),
                    current_situation: '',
                    goals_objectives: '',
                    key_challenges: ''
                });
            }
        };

        const getDefaultCompanyContext = (companyId) => {
            const defaults = {
                aureus: 'Aureus to wiodąca firma leasingowa specjalizująca się w finansowaniu maszyn i sprzętu dla przedsiębiorstw. Oferujemy elastyczne rozwiązania finansowe dostosowane do potrzeb różnych branż.',
                techflow: 'TechFlow to innowacyjna firma IT specjalizująca się w transformacji cyfrowej. Pomagamy firmom modernizować procesy poprzez zaawansowane rozwiązania technologiczne.',
                consultpro: 'ConsultPro to renomowana firma consultingowa oferująca kompleksowe doradztwo biznesowe. Specjalizujemy się w strategii, zarządzaniu zmianą i rozwoju organizacyjnym.',
                custom: 'Opisz swoją firmę, branżę i specjalizację...'
            };
            return defaults[companyId] || '';
        };

        const getDefaultRoleDescription = (companyId) => {
            const defaults = {
                aureus: 'Jako doradca leasingowy pomagam firmom znaleźć optymalne rozwiązania finansowania sprzętu. Analizuję potrzeby klienta i proponuję najlepsze opcje leasingowe.',
                techflow: 'Jako konsultant IT pomagam firmom w cyfrowej transformacji. Analizuję obecne systemy i proponuję nowoczesne rozwiązania technologiczne.',
                consultpro: 'Jako konsultant biznesowy wspieram firmy w optymalizacji procesów i rozwoju strategicznym. Pomagam w implementacji zmian organizacyjnych.',
                custom: 'Opisz swoją rolę w firmie i odpowiedzialności...'
            };
            return defaults[companyId] || '';
        };

        // Helper function to count flows for an avatar
        const getFlowCountForAvatar = (avatar) => {
            if (!avatar || !avatar.flows) return 0;
            return avatar.flows.length;
        };

        // ============ DELETE AVATAR FUNCTION ============

        const deleteAvatar = async (avatarId, avatarName) => {
            if (!confirm(`⚠️ Czy na pewno chcesz usunąć avatar "${avatarName}"?\n\nTo działanie jest nieodwracalne i usunie:\n- Avatar i wszystkie jego dane\n- Wszystkie powiązane flow i intenty\n- Pliki wiedzy i wektory\n\nKliknij OK aby kontynuować.`)) {
                return;
            }

            setIsGenerating(true);
            try {
                const response = await fetch(`/api/avatar/${avatarId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    setMessage(`✅ Avatar "${avatarName}" został usunięty`);

                    // Clear selected avatar if it was deleted
                    if (selectedAvatar?._id === avatarId) {
                        setSelectedAvatar(null);
                    }

                    // Reload avatars list
                    await loadExistingAvatars();

                    console.log('🗑️ Avatar deleted:', result);
                } else {
                    const errorData = await response.json();
                    setMessage(`❌ Błąd usuwania avatara: ${errorData.message || 'Nieznany błąd'}`);
                }
            } catch (error) {
                console.error('Error deleting avatar:', error);
                setMessage('❌ Błąd połączenia podczas usuwania avatara');
            } finally {
                setIsGenerating(false);
            }
        };

        // Load company profiles on mount
        useEffect(() => {
            loadCompanyProfiles();
            // Set default company and load its profile
            selectCompanyForEdit('aureus');
        }, []);

        return React.createElement('div', {className: 'creator-container'},
            // Header
            React.createElement('div', {className: 'creator-header'},
                React.createElement('div', {className: 'header-left'},
                    React.createElement('div', {className: 'creator-title'}, '🧙‍♂️ Avatar & Flow Creator'),
                    React.createElement('div', {className: 'header-nav-buttons'},
                        React.createElement('button', {
                            className: 'nav-btn',
                            onClick: () => window.location.href = '/simulation-chat.html'
                        }, '🎭 Symulacja'),
                        React.createElement('button', {
                            className: 'nav-btn',
                            onClick: () => window.location.href = '/react-dashboard.html'
                        }, '📊 Dashboard')
                    )
                ),
                React.createElement('div', {className: 'header-right'},
                    React.createElement('button', {
                            className: 'nav-btn',
                            onClick: saveCompleteAvatar,
                            disabled: isGenerating || !avatarData.name.trim()
                        }, isGenerating ?
                            React.createElement('span', {className: 'loading'}) : '💾 Zapisz Avatar'
                    ),
                    React.createElement('div', {className: 'creator-tabs'},
                        React.createElement('button', {
                            className: `nav-btn ${activeTab === 'avatar' ? 'active' : ''}`,
                            onClick: () => setActiveTab('avatar')
                        }, '👤 Avatar Selection'),
                        React.createElement('button', {
                            className: `nav-btn ${activeTab === 'flows' ? 'active' : ''}`,
                            onClick: () => setActiveTab('flows')
                        }, '🔄 Flows Manager'),
                        React.createElement('button', {
                            className: `nav-btn ${activeTab === 'flow' ? 'active' : ''}`,
                            onClick: () => setActiveTab('flow')
                        }, '🆕 Flow Creator'),
                        React.createElement('button', {
                            className: `nav-btn ${activeTab === 'reactive' ? 'active' : ''}`,
                            onClick: () => setActiveTab('reactive')
                        }, '🎭 Reactive Avatars'),

                        React.createElement('button', {
                            className: `nav-btn ${activeTab === 'companies' ? 'active' : ''}`,
                            onClick: () => setActiveTab('companies')
                        }, '🏢 Company Profiles')
                    )
                )
            ), // header end

            // Body
            React.createElement('div', {className: 'creator-body'},
                // Form Panel
                React.createElement('div', {className: 'form-panel'},
                    // Message
                    message && React.createElement('div', {
                        className: `alert ${message.includes('✅') ? 'alert-success' : 'alert-error'}`
                    }, message),

                    // Avatar Selection Tab
                    activeTab === 'avatar' && React.createElement('div', null,
                        // Existing Avatars Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('h3', {className: 'section-title'}, '📋 Wybierz Istniejący Avatar'),

                            isLoadingAvatars ?
                                React.createElement('div', {className: 'loading-state'}, 'Ładowanie avatarów...') :
                                React.createElement('div', {className: 'avatar-grid'},
                                    existingAvatars.length === 0 ?
                                        React.createElement('div', {className: 'empty-state'}, 'Brak zapisanych avatarów') :
                                        existingAvatars.map(avatar =>
                                            React.createElement('div', {
                                                    key: avatar._id,
                                                    className: `avatar-card ${selectedAvatar?._id === avatar._id ? 'selected' : ''}`,
                                                    style: {position: 'relative'}
                                                },
                                                // Flow count badge
                                                React.createElement('div', {
                                                    className: `avatar-flow-count ${getFlowCountForAvatar(avatar) === 0 ? 'zero' : getFlowCountForAvatar(avatar) > 1 ? 'multiple' : ''}`,
                                                    title: `Liczba flows: ${getFlowCountForAvatar(avatar)}`
                                                }, `📊 ${getFlowCountForAvatar(avatar)} flows`),

                                                React.createElement('div', {
                                                        onClick: () => setSelectedAvatar(avatar),
                                                        style: {cursor: 'pointer'}
                                                    },
                                                    React.createElement('div', {className: 'avatar-name'}, avatar.name),
                                                    React.createElement('div', {className: 'avatar-desc'}, avatar.description),
                                                    React.createElement('div', {className: 'avatar-specialization'}, avatar.specialization)
                                                ),
                                                React.createElement('button', {
                                                    className: 'delete-avatar-btn',
                                                    onClick: (e) => {
                                                        e.stopPropagation();
                                                        deleteAvatar(avatar._id, avatar.name);
                                                    },
                                                    title: `Usuń avatar: ${avatar.name}`,
                                                    style: {
                                                        position: 'absolute',
                                                        top: '8px',
                                                        right: '8px',
                                                        background: '#dc3545',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '4px',
                                                        width: '24px',
                                                        height: '24px',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        fontSize: '12px',
                                                        zIndex: 10
                                                    }
                                                }, '🗑️')
                                            )
                                        )
                                )
                        ),

                        // OR Divider
                        React.createElement('div', {className: 'divider'},
                            React.createElement('span', null, 'LUB')
                        ),

                        // Create New Avatar Section
                        // Base Description Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('div', {className: 'section-header'},
                                React.createElement('h3', {className: 'section-title'}, '📝 Opis bazowy (dla AI)')
                            ),

                            React.createElement('div', {className: 'form-group'},
                                React.createElement('label', {className: 'form-label'}, 'Opis avatara (dla AI) *'),
                                React.createElement('textarea', {
                                    className: 'form-input form-textarea',
                                    value: avatarData.description,
                                    onChange: (e) => setAvatarData({...avatarData, description: e.target.value}),
                                    placeholder: 'np. Doświadczony prezes firmy technologicznej, charyzmatyczny lider z wizją strategiczną...'
                                })
                            )
                        ),

                        // Name Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('div', {className: 'section-header'},
                                React.createElement('h3', {className: 'section-title'}, '👤 Nazwa avatara'),
                                React.createElement('button', {
                                        className: 'ai-generate-btn',
                                        onClick: () => generateAvatarField('name'),
                                        disabled: isGenerating
                                    }, isGenerating ?
                                        React.createElement('span', {className: 'loading'}) : '✨ Generuj nazwę'
                                )
                            ),

                            React.createElement('div', {className: 'form-group'},
                                React.createElement('input', {
                                    type: 'text',
                                    className: 'form-input',
                                    value: avatarData.name,
                                    onChange: (e) => setAvatarData({...avatarData, name: e.target.value}),
                                    placeholder: 'np. Prezes Firmy'
                                })
                            )
                        ),

                        // Specialization Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('div', {className: 'section-header'},
                                React.createElement('h3', {className: 'section-title'}, '🎯 Specjalizacja'),
                                React.createElement('button', {
                                        className: 'ai-generate-btn',
                                        onClick: () => generateAvatarField('specialization'),
                                        disabled: isGenerating
                                    }, isGenerating ?
                                        React.createElement('span', {className: 'loading'}) : '✨ Generuj specjalizację'
                                )
                            ),

                            React.createElement('div', {className: 'form-group'},
                                React.createElement('textarea', {
                                    className: 'form-input form-textarea',
                                    value: avatarData.specialization,
                                    onChange: (e) => setAvatarData({...avatarData, specialization: e.target.value}),
                                    placeholder: 'np. Zarządzanie strategiczne, rozwój biznesu, leadership'
                                })
                            )
                        ),

                        // Personality Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('div', {className: 'section-header'},
                                React.createElement('h3', {className: 'section-title'}, '🧠 Osobowość'),
                                React.createElement('button', {
                                        className: 'ai-generate-btn',
                                        onClick: () => generateAvatarField('personality'),
                                        disabled: isGenerating
                                    }, isGenerating ?
                                        React.createElement('span', {className: 'loading'}) : '✨ Generuj osobowość'
                                )
                            ),

                            React.createElement('div', {className: 'form-group'},
                                React.createElement('textarea', {
                                    className: 'form-input form-textarea',
                                    value: avatarData.personality,
                                    onChange: (e) => setAvatarData({...avatarData, personality: e.target.value}),
                                    placeholder: 'np. Charyzmatyczny, pewny siebie, inspirujący'
                                })
                            )
                        ),

                        // Communication Style Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('div', {className: 'section-header'},
                                React.createElement('h3', {className: 'section-title'}, '💬 Styl komunikacji'),
                                React.createElement('button', {
                                        className: 'ai-generate-btn',
                                        onClick: () => generateAvatarField('communication_style'),
                                        disabled: isGenerating
                                    }, isGenerating ?
                                        React.createElement('span', {className: 'loading'}) : '✨ Generuj styl'
                                )
                            ),

                            React.createElement('div', {className: 'form-group'},
                                React.createElement('textarea', {
                                    className: 'form-input form-textarea',
                                    value: avatarData.communication_style,
                                    onChange: (e) => setAvatarData({...avatarData, communication_style: e.target.value}),
                                    placeholder: 'np. Pewny siebie, zorientowany na wyniki, motywujący'
                                })
                            )
                        ),

                        // Background Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('div', {className: 'section-header'},
                                React.createElement('h3', {className: 'section-title'}, '📖 Tło/Doświadczenie'),
                                React.createElement('button', {
                                        className: 'ai-generate-btn',
                                        onClick: () => generateAvatarField('background'),
                                        disabled: isGenerating
                                    }, isGenerating ?
                                        React.createElement('span', {className: 'loading'}) : '✨ Generuj tło'
                                )
                            ),

                            React.createElement('div', {className: 'form-group'},
                                React.createElement('textarea', {
                                    className: 'form-input form-textarea',
                                    value: avatarData.background,
                                    onChange: (e) => setAvatarData({...avatarData, background: e.target.value}),
                                    placeholder: 'np. 15-letnie doświadczenie w branży tech, prowadził 3 startupy...'
                                })
                            )
                        ),

                        // Knowledge Upload Section
                        React.createElement('div', {className: 'form-section'},
                            React.createElement('div', {className: 'section-header'},
                                React.createElement('h3', {className: 'section-title'}, '📚 Baza wiedzy'),
                                React.createElement('button', {
                                    className: 'ai-generate-btn',
                                    onClick: () => document.getElementById('knowledge-file-input').click()
                                }, '📁 Dodaj pliki')
                            ),

                            React.createElement('div', {className: 'form-group'},
                                React.createElement('input', {
                                    id: 'knowledge-file-input',
                                    type: 'file',
                                    className: 'file-input',
                                    multiple: true,
                                    accept: '.pdf,.csv,.md,.txt,.docx',
                                    onChange: (e) => handleFileUpload(e.target.files)
                                }),

                                React.createElement('div', {
                                        className: 'knowledge-upload-area',
                                        onClick: () => document.getElementById('knowledge-file-input').click(),
                                        onDragOver: (e) => {
                                            e.preventDefault();
                                            e.currentTarget.classList.add('dragover');
                                        },
                                        onDragLeave: (e) => {
                                            e.preventDefault();
                                            e.currentTarget.classList.remove('dragover');
                                        },
                                        onDrop: (e) => {
                                            e.preventDefault();
                                            e.currentTarget.classList.remove('dragover');
                                            handleFileUpload(e.dataTransfer.files);
                                        }
                                    },
                                    React.createElement('div', {style: {fontSize: '48px', marginBottom: '10px'}}, '📚'),
                                    React.createElement('h4', {
                                        style: {
                                            margin: '10px 0',
                                            color: '#58a6ff'
                                        }
                                    }, 'Przeciągnij pliki lub kliknij aby dodać'),
                                    React.createElement('p', {
                                        style: {
                                            color: '#7d8590',
                                            fontSize: '14px'
                                        }
                                    }, 'Obsługiwane formaty: PDF, CSV, MD, TXT, DOCX (max 10MB)')
                                ),

                                avatarData.knowledge_files.length > 0 && React.createElement('div', {className: 'uploaded-files'},
                                    React.createElement('h4', {style: {color: '#58a6ff', marginBottom: '10px'}},
                                        `📁 Dodane pliki (${avatarData.knowledge_files.length})`
                                    ),
                                    avatarData.knowledge_files.map(file =>
                                        React.createElement('div', {key: file.id, className: 'file-item'},
                                            React.createElement('div', {className: 'file-info'},
                                                React.createElement('span', {className: 'file-icon'}, getFileIcon(file.name)),
                                                React.createElement('div', null,
                                                    React.createElement('div', {className: 'file-name'}, file.name),
                                                    React.createElement('div', {className: 'file-size'}, formatFileSize(file.size))
                                                )
                                            ),
                                            React.createElement('button', {
                                                className: 'remove-file-btn',
                                                onClick: () => removeFile(file.id)
                                            }, '×')
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // Flows Manager Tab
                    activeTab === 'flows' && React.createElement('div', null,
                        !selectedAvatar && React.createElement('div', {className: 'warning-section'},
                            React.createElement('div', {className: 'warning-icon'}, '⚠️'),
                            React.createElement('div', {className: 'warning-text'},
                                React.createElement('h3', null, 'Wybierz Avatar'),
                                React.createElement('p', null, 'Przed zarządzaniem flows musisz wybrać avatar z zakładki "Avatar Selection"')
                            )
                        ),

                        selectedAvatar && React.createElement('div', null,
                            // Selected Avatar Info
                            React.createElement('div', {className: 'selected-avatar-info'},
                                React.createElement('div', {className: 'selected-avatar-name'},
                                    `🎭 ${selectedAvatar.name} - Flows Manager`
                                ),
                                React.createElement('div', {className: 'selected-avatar-desc'},
                                    `Zarządzaj flows dla: ${selectedAvatar.description}`
                                )
                            ),

                            // Existing Flows List
                            React.createElement('div', {className: 'form-section'},
                                React.createElement('h3', {className: 'section-title'}, '🔄 Existing Flows'),

                                selectedAvatar.flows && selectedAvatar.flows.length === 0 ?
                                    React.createElement('div', {className: 'empty-state'},
                                        'Brak flows dla tego avatara. Przejdź do "Flow Creator" żeby stworzyć nowy.'
                                    ) :
                                    React.createElement('div', {className: 'flows-list'},
                                        selectedAvatar.flows && selectedAvatar.flows.map((flow, index) =>
                                            React.createElement('div', {
                                                    key: flow.id,
                                                    className: `flow-item ${selectedFlow?.id === flow.id ? 'selected' : ''}`,
                                                    onClick: () => setSelectedFlow(flow)
                                                },
                                                React.createElement('div', {className: 'flow-header'},
                                                    React.createElement('div', {className: 'flow-name'}, flow.name),
                                                    React.createElement('div', {className: 'flow-actions'},
                                                        React.createElement('button', {
                                                            className: 'nav-btn',
                                                            style: {padding: '4px 8px', fontSize: '12px'},
                                                            onClick: (e) => {
                                                                e.stopPropagation();
                                                                // Załaduj flow do edycji
                                                                setFlowData({
                                                                    name: flow.name || '',
                                                                    description: flow.description || '',
                                                                    steps: flow.steps || [],
                                                                    entry_intents: flow.entry_intents || [],
                                                                    priority: flow.priority || 5
                                                                });
                                                                setActiveTab('flow');
                                                            }
                                                        }, '✏️ Edit'),
                                                        React.createElement('button', {
                                                            className: 'nav-btn',
                                                            style: {
                                                                padding: '4px 8px',
                                                                fontSize: '12px',
                                                                background: 'rgba(220, 38, 38, 0.8) !important',
                                                                color: 'white !important'
                                                            },
                                                            onClick: (e) => {
                                                                e.stopPropagation();
                                                                if (confirm(`Czy na pewno usunąć flow "${flow.name}"?`)) {
                                                                    console.log('Delete flow:', flow.id);
                                                                }
                                                            }
                                                        }, '🗑️ Delete')
                                                    )
                                                ),
                                                React.createElement('div', {className: 'flow-description'}, flow.description),
                                                React.createElement('div', {className: 'flow-stats'},
                                                    `Steps: ${flow.steps?.length || 0} | Intents: ${flow.entry_intents?.length || 0} | Priority: ${flow.priority || 5}`
                                                )
                                            )
                                        )
                                    )
                            ),

                            // ReactFlow Preview for selected flow
                            selectedFlow && React.createElement('div', {className: 'form-section'},
                                React.createElement('h3', {className: 'section-title'},
                                    `🎯 Flow Preview: ${selectedFlow.name}`
                                ),
                                React.createElement('div', {
                                        className: 'flow-graph',
                                        style: {
                                            height: '420px',
                                            border: '1px solid #3a3a3a',
                                            borderRadius: '8px',
                                            background: '#0d1117'
                                        }
                                    },
                                    (window.ZoomableFlowCreator && selectedAvatar) ?
                                        React.createElement(window.ZoomableFlowCreator, {
                                            flowDefinitions: [selectedFlow],
                                            activeFlow: selectedFlow.id,
                                            currentStep: null,
                                            onNodeClick: (node) => {
                                                console.log('Flows Manager node clicked:', node);
                                            },
                                            editable: true,
                                            avatar: selectedAvatar
                                        }) :
                                        React.createElement('div', {
                                            style: {
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                height: '100%',
                                                color: '#8b949e',
                                                fontSize: '16px'
                                            }
                                        }, 'Ładowanie ReactFlow...')
                                )
                            ),

                            // Create New Flow Button
                            React.createElement('div', {className: 'form-section'},
                                React.createElement('button', {
                                    className: 'nav-btn',
                                    style: {padding: '16px 32px', fontSize: '18px'},
                                    onClick: () => setActiveTab('flow')
                                }, '🆕 Stwórz Nowy Flow')
                            )
                        )
                    ),

                    // Flow Creator Tab
                    activeTab === 'flow' && React.createElement('div', null,
                        !selectedAvatar && React.createElement('div', {className: 'warning-section'},
                            React.createElement('div', {className: 'warning-icon'}, '⚠️'),
                            React.createElement('div', {className: 'warning-text'},
                                React.createElement('h3', null, 'Wybierz Avatar'),
                                React.createElement('p', null, 'Przed stworzeniem flow musisz wybrać avatar z zakładki "Avatar Selection"')
                            )
                        ),

                        selectedAvatar && React.createElement('div', null,
                            // Selected Avatar Info
                            React.createElement('div', {className: 'selected-avatar-info'},
                                React.createElement('div', {className: 'selected-avatar-name'},
                                    `🎭 ${selectedAvatar.name}`
                                ),
                                React.createElement('div', {className: 'selected-avatar-desc'},
                                    selectedAvatar.description
                                )
                            ),
                            // Flow Name Section
                            React.createElement('div', {className: 'form-section'},
                                React.createElement('div', {className: 'section-header'},
                                    React.createElement('h3', {className: 'section-title'}, '🔄 Nazwa Flow'),
                                    React.createElement('button', {
                                            className: 'ai-generate-btn',
                                            onClick: () => generateFlowField('name'),
                                            disabled: isGenerating
                                        }, isGenerating ?
                                            React.createElement('span', {className: 'loading'}) : '✨ Generuj nazwę'
                                    )
                                ),

                                React.createElement('div', {className: 'form-group'},
                                    React.createElement('input', {
                                        type: 'text',
                                        className: 'form-input',
                                        value: flowData.name,
                                        onChange: (e) => setFlowData({...flowData, name: e.target.value}),
                                        placeholder: 'np. Leadership Flow'
                                    })
                                )
                            ),

                            // Flow Description Section
                            React.createElement('div', {className: 'form-section'},
                                React.createElement('div', {className: 'section-header'},
                                    React.createElement('h3', {className: 'section-title'}, '📝 Opis Flow'),
                                    React.createElement('button', {
                                            className: 'ai-generate-btn',
                                            onClick: () => generateFlowField('description'),
                                            disabled: isGenerating
                                        }, isGenerating ?
                                            React.createElement('span', {className: 'loading'}) : '✨ Generuj opis'
                                    )
                                ),

                                React.createElement('div', {className: 'form-group'},
                                    React.createElement('textarea', {
                                        className: 'form-input form-textarea',
                                        value: flowData.description,
                                        onChange: (e) => setFlowData({...flowData, description: e.target.value}),
                                        placeholder: 'np. Flow dla prezesa - leadership i wizja strategiczna'
                                    })
                                )
                            ),

                            // Flow Steps Section
                            React.createElement('div', {className: 'form-section'},
                                React.createElement('div', {className: 'section-header'},
                                    React.createElement('h3', {className: 'section-title'}, '📋 Kroki Flow'),
                                    React.createElement('button', {
                                            className: 'ai-generate-btn',
                                            onClick: () => generateFlowField('steps'),
                                            disabled: isGenerating
                                        }, isGenerating ?
                                            React.createElement('span', {className: 'loading'}) : '✨ Generuj kroki'
                                    )
                                ),

                                React.createElement('div', {className: 'form-group'},
                                    React.createElement('label', {className: 'form-label'}, 'Priorytet (1-10)'),
                                    React.createElement('input', {
                                        type: 'number',
                                        min: '1',
                                        max: '10',
                                        className: 'form-input',
                                        value: flowData.priority,
                                        onChange: (e) => setFlowData({...flowData, priority: parseInt(e.target.value)})
                                    })
                                )
                            ),

                            // Live Preview (ReactFlow)
                            (selectedAvatar && flowData.steps.length > 0) && React.createElement('div', {className: 'form-section'},
                                React.createElement('div', {className: 'section-header'},
                                    React.createElement('h3', {className: 'section-title'}, '🎯 Live Preview (ReactFlow)')
                                ),
                                React.createElement('div', {
                                        className: 'flow-graph',
                                        style: {
                                            height: '500px',
                                            border: '1px solid #3a3a3a',
                                            borderRadius: '8px',
                                            background: '#0d1117'
                                        }
                                    },
                                    (window.ZoomableFlowCreator && selectedAvatar) ?
                                        React.createElement(window.ZoomableFlowCreator, {
                                            flowDefinitions: [{
                                                ...flowData,
                                                id: flowData.id || 'preview_flow',
                                                name: flowData.name || 'Preview Flow',
                                                description: flowData.description || '',
                                                avatar_type: selectedAvatar.name
                                            }],
                                            activeFlow: flowData.id || 'preview_flow',
                                            currentStep: null,
                                            onNodeClick: (node) => {
                                                console.log('Flow Creator node clicked:', node);
                                            },
                                            editable: true,
                                            avatar: selectedAvatar
                                        }) :
                                        React.createElement('div', {
                                            style: {
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                height: '100%',
                                                color: '#8b949e'
                                            }
                                        }, 'Ładowanie ReactFlow...')
                                )
                            ),

                            // Flow Visualization
                            flowData.steps.length > 0 && React.createElement('div', {className: 'form-section'},
                                React.createElement('div', {className: 'section-header'},
                                    React.createElement('h3', {className: 'section-title'}, '🎯 Wizualizacja Flow')
                                ),
                                React.createElement('div', {className: 'flow-visualization'},
                                    flowData.steps.map((step, index) =>
                                        React.createElement('div', {key: step.id, className: 'flow-step-node'},
                                            React.createElement('div', {className: 'flow-step-header'},
                                                React.createElement('span', {className: 'flow-step-title'},
                                                    `${index + 1}. ${step.name}`
                                                ),
                                                React.createElement('button', {
                                                    className: 'remove-step-btn',
                                                    onClick: () => removeStep(step.id)
                                                }, '×')
                                            ),
                                            React.createElement('p', {
                                                    style: {
                                                        color: '#c9d1d9',
                                                        fontSize: '14px',
                                                        margin: '10px 0 0 0'
                                                    }
                                                },
                                                step.description
                                            )
                                        )
                                    )
                                )
                            ),

                            // Manual Step Creator
                            React.createElement('div', {className: 'form-section'},
                                React.createElement('div', {className: 'section-header'},
                                    React.createElement('h3', {className: 'section-title'}, '➕ Dodaj krok ręcznie')
                                ),

                                React.createElement('div', {className: 'form-group'},
                                    React.createElement('label', {className: 'form-label'}, 'Nazwa kroku'),
                                    React.createElement('input', {
                                        type: 'text',
                                        className: 'form-input',
                                        value: newStepName,
                                        onChange: (e) => setNewStepName(e.target.value),
                                        placeholder: 'np. Powitanie klienta'
                                    })
                                ),

                                React.createElement('div', {className: 'form-group'},
                                    React.createElement('label', {className: 'form-label'}, 'Opis kroku'),
                                    React.createElement('textarea', {
                                        className: 'form-input form-textarea',
                                        value: newStepDescription,
                                        onChange: (e) => setNewStepDescription(e.target.value),
                                        placeholder: 'np. Przywitaj się z klientem i przedstaw cel rozmowy'
                                    })
                                ),

                                React.createElement('button', {
                                    className: 'add-step-btn',
                                    onClick: addManualStep
                                }, '➕ Dodaj krok')
                            )
                        )
                    )

                    // Intent Creation moved to modal within Flow Creator
                ),

                // Reactive Avatars Tab
                activeTab === 'reactive' && React.createElement('div', null,
                    React.createElement('div', {className: 'form-section'},
                        React.createElement('div', {
                                style: {
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    marginBottom: '20px'
                                }
                            },
                            React.createElement('div', null,
                                React.createElement('h3', {className: 'section-title'}, '🎭 Reactive Avatars Editor'),
                                React.createElement('p', {className: 'section-description'},
                                    'Edytuj system prompts i user prompts dla reaktywnych avatarów (client, student) używanych w symulacjach'
                                )
                            ),
                            React.createElement('button', {
                                className: 'generate-btn',
                                onClick: () => setShowReactiveGenerator(true),
                                disabled: isGenerating
                            }, '🤖 Generuj Nowy Avatar')
                        ),

                        // Reactive Avatars Grid
                        React.createElement('div', {className: 'avatar-grid'},
                            reactiveAvatars.length === 0 ?
                                React.createElement('div', {className: 'loading-state'}, 'Ładowanie reaktywnych avatarów...') :
                                reactiveAvatars.map(avatar =>
                                    React.createElement('div', {
                                            key: avatar.id,
                                            className: `avatar-card ${selectedReactiveAvatar?.id === avatar.id ? 'selected' : ''}`,
                                            onClick: () => {
                                                setSelectedReactiveAvatar(avatar);
                                                setEditingReactivePrompts({
                                                    system_prompt: avatar.custom_prompts.system_prompt || '',
                                                    user_prompt_template: avatar.custom_prompts.user_prompt_template || ''
                                                });
                                            }
                                        },
                                        React.createElement('div', {className: 'avatar-header'},
                                            React.createElement('div', {className: 'avatar-icon'}, avatar.type === 'client' ? '🏢' : '🎓'),
                                            React.createElement('div', {className: 'avatar-title'}, avatar.name)
                                        ),
                                        React.createElement('div', {className: 'avatar-meta'},
                                            React.createElement('div', {className: 'avatar-position'}, avatar.position),
                                            React.createElement('div', {className: 'avatar-company'}, avatar.company)
                                        ),
                                        React.createElement('div', {className: 'avatar-personality'},
                                            avatar.personality.style || 'Reactive Avatar'
                                        ),
                                        React.createElement('div', {className: 'avatar-status'},
                                            avatar.custom_prompts.system_prompt ? '✅ Custom Prompts' : '🔧 Default Prompts'
                                        )
                                    )
                                )
                        )
                    ),

                    // Prompt Editor Section
                    selectedReactiveAvatar && React.createElement('div', {className: 'form-section'},
                        React.createElement('h3', {className: 'section-title'},
                            `✏️ Edycja Promptów - ${selectedReactiveAvatar.name}`
                        ),

                        React.createElement('div', {className: 'prompt-editor-grid'},
                            // System Prompt
                            React.createElement('div', {className: 'prompt-editor-section'},
                                React.createElement('label', {className: 'form-label'}, 'System Prompt'),
                                React.createElement('textarea', {
                                    className: 'form-input form-textarea prompt-textarea',
                                    value: editingReactivePrompts.system_prompt,
                                    onChange: (e) => setEditingReactivePrompts({
                                        ...editingReactivePrompts,
                                        system_prompt: e.target.value
                                    }),
                                    placeholder: `Stwórz system prompt dla ${selectedReactiveAvatar.name} w roli ${selectedReactiveAvatar.type}a...`,
                                    rows: 8
                                })
                            ),

                            // User Prompt Template
                            React.createElement('div', {className: 'prompt-editor-section'},
                                React.createElement('label', {className: 'form-label'}, 'User Prompt Template'),
                                React.createElement('textarea', {
                                    className: 'form-input form-textarea prompt-textarea',
                                    value: editingReactivePrompts.user_prompt_template,
                                    onChange: (e) => setEditingReactivePrompts({
                                        ...editingReactivePrompts,
                                        user_prompt_template: e.target.value
                                    }),
                                    placeholder: 'Rozmówca napisał: "{{user_message}}"\n\nTwoje zadanie jako ${selectedReactiveAvatar.type}:\n1. ...\n2. ...',
                                    rows: 8
                                })
                            )
                        ),

                        // Save Button
                        React.createElement('div', {className: 'form-actions'},
                            React.createElement('button', {
                                className: 'save-btn',
                                onClick: async () => {
                                    try {
                                        setIsGenerating(true);

                                        const response = await fetch(`/api/reactive-avatars/${selectedReactiveAvatar.id}/prompts`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify(editingReactivePrompts)
                                        });

                                        if (response.ok) {
                                            // Update local state
                                            const updatedAvatars = reactiveAvatars.map(avatar =>
                                                avatar.id === selectedReactiveAvatar.id ?
                                                    {...avatar, custom_prompts: editingReactivePrompts} :
                                                    avatar
                                            );
                                            setReactiveAvatars(updatedAvatars);
                                            setSelectedReactiveAvatar({
                                                ...selectedReactiveAvatar,
                                                custom_prompts: editingReactivePrompts
                                            });

                                            setMessage('✅ Zapisano prompty dla ' + selectedReactiveAvatar.name);
                                        } else {
                                            setMessage('❌ Błąd podczas zapisywania promptów');
                                        }
                                    } catch (error) {
                                        console.error('Error saving prompts:', error);
                                        setMessage('❌ Błąd podczas zapisywania promptów');
                                    } finally {
                                        setIsGenerating(false);
                                    }
                                }
                            }, '💾 Zapisz Prompty')
                        )
                    )
                ),

                // ============ REACTIVE AVATAR GENERATOR MODAL ============
                showReactiveGenerator && React.createElement('div', {className: 'modal-overlay'},
                    React.createElement('div', {className: 'modal-content large-modal'},
                        React.createElement('div', {className: 'modal-header'},
                            React.createElement('h3', null, '🤖 Generator Reaktywnych Avatarów'),
                            React.createElement('button', {
                                className: 'close-btn',
                                onClick: () => {
                                    setShowReactiveGenerator(false);
                                    setGeneratedReactiveAvatar(null);
                                    setReactiveGeneratorData({description: '', avatarType: 'client'});
                                }
                            }, '×')
                        ),

                        React.createElement('div', {className: 'modal-body'},
                            !generatedReactiveAvatar ?
                                // Generator Form
                                React.createElement('div', null,
                                    React.createElement('p', {className: 'section-description'},
                                        'Opisz jakiego reaktywnego avatara chcesz stworzyć. AI wygeneruje kompletny profil z osobowością, firmą i specjalizacjami.'
                                    ),

                                    React.createElement('div', {className: 'form-group'},
                                        React.createElement('label', {className: 'form-label'}, 'Typ Avatara'),
                                        React.createElement('select', {
                                                className: 'form-input',
                                                value: reactiveGeneratorData.avatarType,
                                                onChange: (e) => setReactiveGeneratorData({
                                                    ...reactiveGeneratorData,
                                                    avatarType: e.target.value
                                                })
                                            },
                                            React.createElement('option', {value: 'client'}, '🏢 Client - Klient biznesowy, właściciel firmy'),
                                            React.createElement('option', {value: 'student'}, '🎓 Student - Uczestnik szkolenia, chętny do nauki'),
                                            React.createElement('option', {value: 'employee'}, '👔 Employee - Pracownik firmy, wykonawczy')
                                        )
                                    ),

                                    React.createElement('div', {className: 'form-group'},
                                        React.createElement('label', {className: 'form-label'}, 'Opis Avatara'),
                                        React.createElement('textarea', {
                                            className: 'form-input form-textarea',
                                            value: reactiveGeneratorData.description,
                                            onChange: (e) => setReactiveGeneratorData({
                                                ...reactiveGeneratorData,
                                                description: e.target.value
                                            }),
                                            placeholder: 'Np. "Właściciel małej firmy produkcyjnej, sceptyczny wobec nowych technologii, skupiony na kosztach i jakości. Ma 20 lat doświadczenia w branży metalowej."',
                                            rows: 4
                                        })
                                    ),

                                    React.createElement('div', {className: 'form-actions'},
                                        React.createElement('button', {
                                            className: 'generate-btn',
                                            onClick: generateReactiveAvatar,
                                            disabled: isGenerating || !reactiveGeneratorData.description.trim()
                                        }, isGenerating ? 'Generuję...' : '🤖 Generuj Avatar'),

                                        React.createElement('button', {
                                            className: 'cancel-btn',
                                            onClick: () => setShowReactiveGenerator(false)
                                        }, 'Anuluj')
                                    )
                                ) :
                                // Generated Avatar Preview
                                React.createElement('div', null,
                                    React.createElement('h4', {style: {color: '#58a6ff', marginBottom: '20px'}},
                                        `✅ Wygenerowano: ${generatedReactiveAvatar.firstName} ${generatedReactiveAvatar.lastName}`
                                    ),

                                    React.createElement('div', {className: 'generated-avatar-preview'},
                                        React.createElement('div', {className: 'avatar-info-grid'},
                                            React.createElement('div', {className: 'info-section'},
                                                React.createElement('h5', null, '👤 Dane Osobowe'),
                                                React.createElement('p', null, `Imię: ${generatedReactiveAvatar.firstName}`),
                                                React.createElement('p', null, `Nazwisko: ${generatedReactiveAvatar.lastName}`),
                                                React.createElement('p', null, `Stanowisko: ${generatedReactiveAvatar.position}`),
                                                React.createElement('p', null, `Doświadczenie: ${generatedReactiveAvatar.experience_years} lat`)
                                            ),

                                            React.createElement('div', {className: 'info-section'},
                                                React.createElement('h5', null, '🏢 Firma'),
                                                React.createElement('p', null, `Nazwa: ${generatedReactiveAvatar.company.name}`),
                                                React.createElement('p', null, `Branża: ${generatedReactiveAvatar.company.industry}`),
                                                React.createElement('p', null, `Lokalizacja: ${generatedReactiveAvatar.company.location}`),
                                                React.createElement('p', null, `Rozmiar: ${generatedReactiveAvatar.company.size}`)
                                            ),

                                            React.createElement('div', {className: 'info-section'},
                                                React.createElement('h5', null, '🧠 Osobowość'),
                                                React.createElement('p', null, `Styl: ${generatedReactiveAvatar.personality.style}`),
                                                React.createElement('p', null, `Ton: ${generatedReactiveAvatar.personality.tone}`),
                                                React.createElement('p', null, `Motywacja: ${generatedReactiveAvatar.personality.business_motivation}`)
                                            ),

                                            React.createElement('div', {className: 'info-section'},
                                                React.createElement('h5', null, '🎯 Specjalizacje'),
                                                React.createElement('div', {className: 'tags'},
                                                    generatedReactiveAvatar.specializations.map((spec, index) =>
                                                        React.createElement('span', {key: index, className: 'tag'}, spec)
                                                    )
                                                )
                                            )
                                        )
                                    ),

                                    React.createElement('div', {className: 'form-actions', style: {marginTop: '20px'}},
                                        React.createElement('button', {
                                            className: 'save-btn',
                                            onClick: addGeneratedAvatarToSystem,
                                            disabled: isGenerating
                                        }, isGenerating ? 'Dodaję...' : '✅ Dodaj do Systemu'),

                                        React.createElement('button', {
                                            className: 'generate-btn',
                                            onClick: generateReactiveAvatar,
                                            disabled: isGenerating
                                        }, '🔄 Generuj Ponownie'),

                                        React.createElement('button', {
                                            className: 'cancel-btn',
                                            onClick: () => {
                                                setGeneratedReactiveAvatar(null);
                                                setReactiveGeneratorData({description: '', avatarType: 'client'});
                                            }
                                        }, 'Nowy Avatar')
                                    )
                                )
                        )
                    )
                )
            ),

            // ============ COMPANY PROFILES TAB ============
            activeTab === 'companies' && React.createElement('div', null,
                React.createElement('h2', {style: {marginBottom: '20px', color: '#58a6ff'}}, '🏢 Company Profiles Editor'),
                React.createElement('p', {style: {marginBottom: '20px', color: '#8b949e'}},
                    'Edytuj profile firm do używania w symulacji. Te informacje będą przekazywane reaktywnym avatarom.'
                ),

                // Company Selection
                React.createElement('div', {className: 'avatar-grid', style: {marginBottom: '30px'}},
                    ['aureus', 'techflow', 'consultpro', 'custom'].map(companyId => {
                        const companyNames = {
                            aureus: 'Aureus (Leasing)',
                            techflow: 'TechFlow (IT)',
                            consultpro: 'ConsultPro (Consulting)',
                            custom: 'Custom (Własna)'
                        };

                        return React.createElement('div', {
                                key: companyId,
                                className: `avatar-card ${selectedCompany === companyId ? 'selected' : ''}`,
                                onClick: () => selectCompanyForEdit(companyId),
                                style: {cursor: 'pointer'}
                            },
                            React.createElement('div', {className: 'avatar-name'}, companyNames[companyId]),
                            React.createElement('div', {className: 'avatar-status'},
                                companyProfiles[companyId] ? '✅ Skonfigurowany' : '⚠️ Domyślny'
                            )
                        );
                    })
                ),

                // Company Profile Editor
                selectedCompany && React.createElement('div', {className: 'prompt-editor-grid'},
                    // Company Context
                    React.createElement('div', {className: 'prompt-editor-section'},
                        React.createElement('h3', null, '🏢 Kontekst Firmy'),
                        React.createElement('p', {style: {fontSize: '14px', color: '#8b949e', marginBottom: '10px'}},
                            'Opisz swoją firmę, branżę, ofertę i pozycję na rynku'
                        ),
                        React.createElement('textarea', {
                            className: 'prompt-textarea',
                            value: editingCompanyProfile.company_context,
                            onChange: (e) => setEditingCompanyProfile({
                                ...editingCompanyProfile,
                                company_context: e.target.value
                            }),
                            placeholder: 'Opisz swoją firmę, jej misję, główne usługi...',
                            rows: 6
                        })
                    ),

                    // Your Role Description
                    React.createElement('div', {className: 'prompt-editor-section'},
                        React.createElement('h3', null, '👤 Twoja Rola'),
                        React.createElement('p', {style: {fontSize: '14px', color: '#8b949e', marginBottom: '10px'}},
                            'Opisz swoją rolę, odpowiedzialności i kompetencje'
                        ),
                        React.createElement('textarea', {
                            className: 'prompt-textarea',
                            value: editingCompanyProfile.your_role_description,
                            onChange: (e) => setEditingCompanyProfile({
                                ...editingCompanyProfile,
                                your_role_description: e.target.value
                            }),
                            placeholder: 'Jako [twoje stanowisko] odpowiadam za...',
                            rows: 4
                        })
                    ),

                    // Current Situation
                    React.createElement('div', {className: 'prompt-editor-section'},
                        React.createElement('h3', null, '📊 Aktualna Sytuacja'),
                        React.createElement('p', {style: {fontSize: '14px', color: '#8b949e', marginBottom: '10px'}},
                            'Opisz kontekst tej konkretnej rozmowy/spotkania'
                        ),
                        React.createElement('textarea', {
                            className: 'prompt-textarea',
                            value: editingCompanyProfile.current_situation,
                            onChange: (e) => setEditingCompanyProfile({
                                ...editingCompanyProfile,
                                current_situation: e.target.value
                            }),
                            placeholder: 'W tej rozmowie chcę... / Spotkanie dotyczy...',
                            rows: 3
                        })
                    ),

                    // Goals & Objectives
                    React.createElement('div', {className: 'prompt-editor-section'},
                        React.createElement('h3', null, '🎯 Cele i Zadania'),
                        React.createElement('p', {style: {fontSize: '14px', color: '#8b949e', marginBottom: '10px'}},
                            'Jakie cele chcesz osiągnąć w tej rozmowie?'
                        ),
                        React.createElement('textarea', {
                            className: 'prompt-textarea',
                            value: editingCompanyProfile.goals_objectives,
                            onChange: (e) => setEditingCompanyProfile({
                                ...editingCompanyProfile,
                                goals_objectives: e.target.value
                            }),
                            placeholder: 'Moje cele: 1) ... 2) ... 3) ...',
                            rows: 3
                        })
                    ),

                    // Key Challenges
                    React.createElement('div', {className: 'prompt-editor-section'},
                        React.createElement('h3', null, '⚠️ Kluczowe Wyzwania'),
                        React.createElement('p', {style: {fontSize: '14px', color: '#8b949e', marginBottom: '10px'}},
                            'Jakie wyzwania/obawy możesz napotkać?'
                        ),
                        React.createElement('textarea', {
                            className: 'prompt-textarea',
                            value: editingCompanyProfile.key_challenges,
                            onChange: (e) => setEditingCompanyProfile({
                                ...editingCompanyProfile,
                                key_challenges: e.target.value
                            }),
                            placeholder: 'Potencjalne wyzwania: budżet, czas, skeptycyzm...',
                            rows: 3
                        })
                    ),

                    // Save Button
                    React.createElement('div', {
                            className: 'prompt-editor-section',
                            style: {gridColumn: '1 / -1', display: 'flex', justifyContent: 'center'}
                        },
                        React.createElement('button', {
                            className: 'save-btn',
                            onClick: saveCompanyProfile,
                            disabled: isGenerating,
                            style: {
                                padding: '12px 24px',
                                fontSize: '16px',
                                fontWeight: 'bold'
                            }
                        }, isGenerating ? '💾 Zapisywanie...' : '💾 Zapisz Profil Firmy')
                    )
                )
            ) // form-panel end
        ) // creator-body end
            ; // creator-container end
    }


    // Render the app
    ReactDOM.render(React.createElement(AvatarFlowCreator), document.getElementById('root'));
</script>
</body>
</html>
