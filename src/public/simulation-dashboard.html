<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Avatar - Symulacja Konwersacji</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
    <script src="https://unpkg.com/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }
        
        .header {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .header h1 {
            color: #58a6ff;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            color: #7d8590;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: color 0.2s, background-color 0.2s;
        }

        .nav-link:hover {
            color: #58a6ff;
            background-color: #21262d;
        }

        .nav-link.active {
            color: #58a6ff;
            background-color: #21262d;
        }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .simulation-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .panel h2 {
            color: #f0f6fc;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #f0f6fc;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: #238636;
            color: white;
        }

        .btn-primary:hover {
            background: #2ea043;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(35, 134, 54, 0.3);
        }

        .btn-secondary {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .btn-secondary:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        .btn-danger {
            background: #da3633;
            color: white;
        }

        .btn-danger:hover {
            background: #f85149;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .participant-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .participant-name {
            font-weight: 600;
            color: #58a6ff;
        }

        .participant-role {
            background: #21262d;
            color: #7d8590;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .message-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            background: #0d1117;
        }

        .message {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            position: relative;
        }

        .message.participant-1 {
            background: #1a2332;
            border-left: 3px solid #58a6ff;
        }

        .message.participant-2 {
            background: #2d1b30;
            border-left: 3px solid #a5a5f0;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-author {
            font-weight: 600;
            color: #f0f6fc;
        }

        .message-time {
            font-size: 0.75rem;
            color: #7d8590;
        }

        .message-content {
            color: #c9d1d9;
            line-height: 1.5;
        }

        .simulation-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .status-running {
            background: rgba(35, 134, 54, 0.2);
            color: #56d364;
            border: 1px solid rgba(35, 134, 54, 0.3);
        }

        .status-paused {
            background: rgba(255, 191, 0, 0.2);
            color: #f0b90b;
            border: 1px solid rgba(255, 191, 0, 0.3);
        }

        .status-completed {
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
            border: 1px solid rgba(88, 166, 255, 0.3);
        }

        .status-error {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #238636, #56d364);
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #58a6ff;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #7d8590;
            margin-top: 0.25rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #30363d;
            border-radius: 50%;
            border-top-color: #58a6ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            color: #f85149;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .scenario-template {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-template:hover {
            border-color: #58a6ff;
            background: #161b22;
        }

        .scenario-template.selected {
            border-color: #58a6ff;
            background: #1a2332;
        }

        .scenario-title {
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 0.5rem;
        }

        .scenario-description {
            color: #7d8590;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .scenario-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: #7d8590;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Service for simulation endpoints
        const SimulationAPI = {
            async createSimulation(scenario, config) {
                const response = await fetch('/api/simulation/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario, config })
                });
                return await response.json();
            },

            async getSimulation(id) {
                const response = await fetch(`/api/simulation/${id}`);
                return await response.json();
            },

            async getSimulationMessages(id, limit = 50, offset = 0) {
                const response = await fetch(`/api/simulation/${id}/messages?limit=${limit}&offset=${offset}`);
                return await response.json();
            },

            async getSimulationAnalysis(id) {
                const response = await fetch(`/api/simulation/${id}/analysis`);
                return await response.json();
            },

            async pauseSimulation(id) {
                const response = await fetch(`/api/simulation/${id}/pause`, { method: 'POST' });
                return await response.json();
            },

            async resumeSimulation(id, config) {
                const response = await fetch(`/api/simulation/${id}/resume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config })
                });
                return await response.json();
            },

            async getActiveSimulations() {
                const response = await fetch('/api/simulation/active');
                return await response.json();
            },

            async getScenarioTemplates() {
                const response = await fetch('/api/simulation/templates/scenarios');
                return await response.json();
            },

            async getPersonaTemplates() {
                const response = await fetch('/api/simulation/templates/personas');
                return await response.json();
            },

            // ============ PERSONA API METHODS ============

            async generatePersona(description, role, industry, companySize, saveToLibrary = true, tags = []) {
                const response = await fetch('/api/persona/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description,
                        role,
                        industry,
                        companySize,
                        saveToLibrary,
                        tags
                    })
                });
                return await response.json();
            },

            async getPersonaLibrary(search = '', tags = [], role = '', industry = '', favoritesOnly = false) {
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (tags.length > 0) params.append('tags', tags.join(','));
                if (role) params.append('role', role);
                if (industry) params.append('industry', industry);
                if (favoritesOnly) params.append('favorites_only', 'true');

                const response = await fetch(`/api/persona/library?${params}`);
                return await response.json();
            },

            async getPersonaLibraryStats() {
                const response = await fetch('/api/persona/library/stats');
                return await response.json();
            },

            async getPopularPersonas(limit = 10) {
                const response = await fetch(`/api/persona/library/popular?limit=${limit}`);
                return await response.json();
            },

            async getPersona(personaId) {
                const response = await fetch(`/api/persona/${personaId}`);
                return await response.json();
            },

            async updatePersona(personaId, updates) {
                const response = await fetch(`/api/persona/${personaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                return await response.json();
            },

            async deletePersona(personaId) {
                const response = await fetch(`/api/persona/${personaId}`, {
                    method: 'DELETE'
                });
                return await response.json();
            },

            async toggleFavoritePersona(personaId) {
                const response = await fetch(`/api/persona/${personaId}/favorite`, {
                    method: 'POST'
                });
                return await response.json();
            },

            async ratePersona(personaId, rating) {
                const response = await fetch(`/api/persona/${personaId}/rate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating })
                });
                return await response.json();
            },

            async createParticipantFromPersona(personaId, role, avatarType = 'networker') {
                const response = await fetch(`/api/persona/${personaId}/participant`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role, avatarType })
                });
                return await response.json();
            },

            async generateExamplePersonas() {
                const response = await fetch('/api/persona/examples', {
                    method: 'POST'
                });
                return await response.json();
            },

            async exportSimulation(id, format = 'json') {
                const response = await fetch(`/api/simulation/export/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ format })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `simulation_${id}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
                
                return response.ok;
            }
        };

        // Main Simulation Dashboard Component
        function SimulationDashboard() {
            const [activeTab, setActiveTab] = useState('create');
            const [simulations, setSimulations] = useState([]);
            const [selectedSimulation, setSelectedSimulation] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [personaLibrary, setPersonaLibrary] = useState([]);
            const [customScenario, setCustomScenario] = useState(null);

            // Load active simulations and persona library on mount
            useEffect(() => {
                loadActiveSimulations();
                loadPersonaLibrary();
            }, []);

            const loadPersonaLibrary = async () => {
                try {
                    const result = await SimulationAPI.getPersonaLibrary();
                    if (result.success) {
                        setPersonaLibrary(result.data.personas);
                    }
                } catch (err) {
                    console.error('Error loading persona library:', err);
                }
            };

            const loadActiveSimulations = async () => {
                try {
                    const result = await SimulationAPI.getActiveSimulations();
                    if (result.success) {
                        setSimulations(result.data.simulations);
                    }
                } catch (err) {
                    console.error('Error loading simulations:', err);
                }
            };

            const handleSimulationCreated = (newSimulation) => {
                setSimulations(prev => [...prev, newSimulation]);
                setActiveTab('monitor');
                setSelectedSimulation(newSimulation.id);
            };

            return (
                <div>
                    <header className="header">
                        <h1>üß™ Symulacja Konwersacji AI</h1>
                        <nav className="nav-links">
                            <a href="/react-dashboard.html" className="nav-link">Dashboard</a>
                            <a href="/simulation-dashboard.html" className="nav-link active">Symulacja</a>
                        </nav>
                    </header>

                    <div className="main-content">
                        <div className="header-controls" style={{ marginBottom: '2rem' }}>
                            <button 
                                className={`btn ${activeTab === 'create' ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => setActiveTab('create')}
                            >
                                ‚ûï Nowa Symulacja
                            </button>
                            <button 
                                className={`btn ${activeTab === 'personas' ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => setActiveTab('personas')}
                            >
                                üë• Biblioteka Postaci
                            </button>
                            <button 
                                className={`btn ${activeTab === 'custom' ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => setActiveTab('custom')}
                            >
                                üé® Kreator Scenariusza
                            </button>
                            <button 
                                className={`btn ${activeTab === 'wizard' ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => window.open('/avatar-flow-creator.html', '_blank')}
                            >
                                üßô‚Äç‚ôÇÔ∏è Avatar & Flow Creator
                            </button>
                            <button 
                                className={`btn ${activeTab === 'monitor' ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => setActiveTab('monitor')}
                            >
                                üìä Monitorowanie
                            </button>
                            <button 
                                className={`btn ${activeTab === 'analysis' ? 'btn-primary' : 'btn-secondary'}`}
                                onClick={() => setActiveTab('analysis')}
                            >
                                üìà Analiza
                            </button>
                        </div>

                        {error && (
                            <div className="error-message">
                                ‚ùå {error}
                            </div>
                        )}

                        {activeTab === 'create' && (
                            <SimulationCreator 
                                onSimulationCreated={handleSimulationCreated}
                                isLoading={isLoading}
                                setIsLoading={setIsLoading}
                                setError={setError}
                            />
                        )}

                        {activeTab === 'personas' && (
                            <PersonaLibrary 
                                personas={personaLibrary}
                                onRefresh={loadPersonaLibrary}
                                setError={setError}
                            />
                        )}

                        {activeTab === 'custom' && (
                            <CustomScenarioCreator 
                                personas={personaLibrary}
                                onScenarioCreated={setCustomScenario}
                                setError={setError}
                            />
                        )}

                        {activeTab === 'wizard' && (
                            <VisualFlowDesigner 
                                setError={setError}
                            />
                        )}

                        {activeTab === 'monitor' && (
                            <SimulationMonitor 
                                simulations={simulations}
                                selectedSimulation={selectedSimulation}
                                setSelectedSimulation={setSelectedSimulation}
                                onRefresh={loadActiveSimulations}
                            />
                        )}

                        {activeTab === 'analysis' && (
                            <SimulationAnalysis 
                                simulations={simulations}
                                selectedSimulation={selectedSimulation}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // ============ PERSONA LIBRARY COMPONENT ============
        function PersonaLibrary({ personas, onRefresh, setError }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const [selectedPersona, setSelectedPersona] = useState(null);

            const filteredPersonas = personas.filter(stored => 
                stored.persona.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                stored.persona.industry.toLowerCase().includes(searchTerm.toLowerCase()) ||
                stored.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const handleGenerateExamples = async () => {
                setIsGenerating(true);
                try {
                    const result = await SimulationAPI.generateExamplePersonas();
                    if (result.success) {
                        await onRefresh();
                        alert(`‚úÖ Wygenerowano ${result.data.count} przyk≈Çadowych postaci!`);
                    } else {
                        setError('B≈ÇƒÖd podczas generowania przyk≈Çad√≥w');
                    }
                } catch (err) {
                    setError('B≈ÇƒÖd podczas generowania przyk≈Çad√≥w');
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleToggleFavorite = async (personaId) => {
                try {
                    await SimulationAPI.toggleFavoritePersona(personaId);
                    await onRefresh();
                } catch (err) {
                    setError('B≈ÇƒÖd podczas zmiany statusu ulubionej');
                }
            };

            const handleDeletePersona = async (personaId) => {
                if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô personƒô?')) {
                    try {
                        await SimulationAPI.deletePersona(personaId);
                        await onRefresh();
                    } catch (err) {
                        setError('B≈ÇƒÖd podczas usuwania persony');
                    }
                }
            };

            return (
                <div className="persona-library">
                    <div className="library-header" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h2>üë• Biblioteka Postaci</h2>
                        <div style={{ display: 'flex', gap: '1rem' }}>
                            <input
                                type="text"
                                placeholder="üîç Szukaj postaci..."
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                style={{ 
                                    padding: '0.5rem 1rem', 
                                    borderRadius: '6px', 
                                    border: '1px solid #30363d',
                                    backgroundColor: '#21262d',
                                    color: '#e6edf3'
                                }}
                            />
                            <button 
                                className="btn btn-secondary"
                                onClick={() => setShowCreateForm(!showCreateForm)}
                            >
                                ‚ûï Nowa Postaƒá
                            </button>
                            {personas.length === 0 && (
                                <button 
                                    className="btn btn-primary"
                                    onClick={handleGenerateExamples}
                                    disabled={isGenerating}
                                >
                                    {isGenerating ? '‚è≥ Generujƒô...' : 'üé≤ Przyk≈Çady'}
                                </button>
                            )}
                        </div>
                    </div>

                    {showCreateForm && (
                        <PersonaCreator 
                            onPersonaCreated={onRefresh}
                            onCancel={() => setShowCreateForm(false)}
                            setError={setError}
                        />
                    )}

                    <div className="personas-grid" style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', 
                        gap: '1.5rem' 
                    }}>
                        {filteredPersonas.map(stored => (
                            <PersonaCard 
                                key={stored.id}
                                storedPersona={stored}
                                onToggleFavorite={handleToggleFavorite}
                                onDelete={handleDeletePersona}
                                onSelect={setSelectedPersona}
                            />
                        ))}
                    </div>

                    {filteredPersonas.length === 0 && (
                        <div style={{ 
                            textAlign: 'center', 
                            padding: '3rem', 
                            color: '#7d8590',
                            backgroundColor: '#0d1117',
                            borderRadius: '12px',
                            border: '1px solid #30363d'
                        }}>
                            <h3>üìö Brak postaci w bibliotece</h3>
                            <p>Rozpocznij od stworzenia nowej postaci lub wygenerowania przyk≈Çad√≥w</p>
                        </div>
                    )}

                    {selectedPersona && (
                        <PersonaDetailModal 
                            persona={selectedPersona}
                            onClose={() => setSelectedPersona(null)}
                            onRefresh={onRefresh}
                        />
                    )}
                </div>
            );
        }

        // ============ PERSONA CREATOR COMPONENT ============
        function PersonaCreator({ onPersonaCreated, onCancel, setError }) {
            const [formData, setFormData] = useState({
                description: '',
                role: 'seller',
                industry: '',
                companySize: '',
                tags: ''
            });
            const [isGenerating, setIsGenerating] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsGenerating(true);

                try {
                    const tags = formData.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                    const result = await SimulationAPI.generatePersona(
                        formData.description,
                        formData.role,
                        formData.industry,
                        formData.companySize,
                        true,
                        tags
                    );

                    if (result.success) {
                        await onPersonaCreated();
                        onCancel();
                        alert(`‚úÖ Utworzono nowƒÖ personƒô: ${result.data.persona.name}`);
                    } else {
                        setError('B≈ÇƒÖd podczas tworzenia persony');
                    }
                } catch (err) {
                    setError('B≈ÇƒÖd podczas tworzenia persony');
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div style={{ 
                    backgroundColor: '#161b22', 
                    border: '1px solid #30363d', 
                    borderRadius: '12px', 
                    padding: '2rem',
                    marginBottom: '2rem'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h3>üé® Kreator Nowej Postaci</h3>
                        <button className="btn btn-secondary" onClick={onCancel}>
                            ‚úï Zamknij
                        </button>
                    </div>

                    <form onSubmit={handleSubmit}>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Rola w symulacji:</label>
                                <select
                                    value={formData.role}
                                    onChange={(e) => setFormData({...formData, role: e.target.value})}
                                    style={{ 
                                        width: '100%', 
                                        padding: '0.5rem', 
                                        borderRadius: '6px', 
                                        border: '1px solid #30363d',
                                        backgroundColor: '#21262d',
                                        color: '#e6edf3'
                                    }}
                                >
                                    <option value="seller">ü§ù Sprzedawca/Networker</option>
                                    <option value="buyer">üíº Klient/KupujƒÖcy</option>
                                    <option value="teacher">üéì Trener/Nauczyciel</option>
                                    <option value="learner">üìö Ucze≈Ñ/Student</option>
                                    <option value="interviewer">üé§ Rekruter</option>
                                    <option value="interviewee">üë§ Kandydat</option>
                                </select>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Bran≈ºa:</label>
                                <input
                                    type="text"
                                    placeholder="np. IT, Finanse, Marketing..."
                                    value={formData.industry}
                                    onChange={(e) => setFormData({...formData, industry: e.target.value})}
                                    style={{ 
                                        width: '100%', 
                                        padding: '0.5rem', 
                                        borderRadius: '6px', 
                                        border: '1px solid #30363d',
                                        backgroundColor: '#21262d',
                                        color: '#e6edf3'
                                    }}
                                />
                            </div>
                        </div>

                        <div style={{ marginBottom: '1rem' }}>
                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Opis postaci:</label>
                            <textarea
                                placeholder="Opisz postaƒá, np. 'Dyrektor IT w ≈õredniej firmie, 10 lat do≈õwiadczenia, specjalizuje siƒô w transformacji cyfrowej...' "
                                value={formData.description}
                                onChange={(e) => setFormData({...formData, description: e.target.value})}
                                required
                                rows={3}
                                style={{ 
                                    width: '100%', 
                                    padding: '0.75rem', 
                                    borderRadius: '6px', 
                                    border: '1px solid #30363d',
                                    backgroundColor: '#21262d',
                                    color: '#e6edf3',
                                    resize: 'vertical'
                                }}
                            />
                        </div>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Wielko≈õƒá firmy:</label>
                                <select
                                    value={formData.companySize}
                                    onChange={(e) => setFormData({...formData, companySize: e.target.value})}
                                    style={{ 
                                        width: '100%', 
                                        padding: '0.5rem', 
                                        borderRadius: '6px', 
                                        border: '1px solid #30363d',
                                        backgroundColor: '#21262d',
                                        color: '#e6edf3'
                                    }}
                                >
                                    <option value="">Wybierz wielko≈õƒá...</option>
                                    <option value="Startup (5-10 os√≥b)">Startup (5-10 os√≥b)</option>
                                    <option value="≈örednia firma (50-250 os√≥b)">≈örednia firma (50-250 os√≥b)</option>
                                    <option value="Du≈ºa korporacja (500+ os√≥b)">Du≈ºa korporacja (500+ os√≥b)</option>
                                </select>
                            </div>
                            <div>
                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Tagi (przez przecinek):</label>
                                <input
                                    type="text"
                                    placeholder="np. senior, B2B, marketing..."
                                    value={formData.tags}
                                    onChange={(e) => setFormData({...formData, tags: e.target.value})}
                                    style={{ 
                                        width: '100%', 
                                        padding: '0.5rem', 
                                        borderRadius: '6px', 
                                        border: '1px solid #30363d',
                                        backgroundColor: '#21262d',
                                        color: '#e6edf3'
                                    }}
                                />
                            </div>
                        </div>

                        <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
                            <button type="button" className="btn btn-secondary" onClick={onCancel}>
                                Anuluj
                            </button>
                            <button type="submit" className="btn btn-primary" disabled={isGenerating}>
                                {isGenerating ? 'ü§ñ AI generuje personƒô...' : '‚ú® Utw√≥rz personƒô'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        // ============ PERSONA CARD COMPONENT ============
        function PersonaCard({ storedPersona, onToggleFavorite, onDelete, onSelect }) {
            const { id, persona, tags, usage_count, rating, is_favorite } = storedPersona;

            return (
                <div 
                    className="persona-card"
                    style={{ 
                        backgroundColor: '#161b22',
                        border: is_favorite ? '2px solid #f85149' : '1px solid #30363d',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        cursor: 'pointer',
                        transition: 'all 0.2s',
                        position: 'relative'
                    }}
                    onClick={() => onSelect(storedPersona)}
                    onMouseEnter={(e) => e.target.style.borderColor = '#58a6ff'}
                    onMouseLeave={(e) => e.target.style.borderColor = is_favorite ? '#f85149' : '#30363d'}
                >
                    {is_favorite && (
                        <div style={{ position: 'absolute', top: '1rem', right: '1rem', fontSize: '1.2rem' }}>
                            ‚≠ê
                        </div>
                    )}

                    <div style={{ marginBottom: '1rem' }}>
                        <h4 style={{ margin: '0 0 0.5rem 0', color: '#e6edf3' }}>{persona.name}</h4>
                        <p style={{ 
                            margin: '0 0 0.5rem 0', 
                            color: '#7d8590', 
                            fontSize: '0.9rem',
                            lineHeight: '1.4',
                            display: '-webkit-box',
                            WebkitLineClamp: 2,
                            WebkitBoxOrient: 'vertical',
                            overflow: 'hidden'
                        }}>
                            {persona.background}
                        </p>
                        <div style={{ display: 'flex', gap: '0.5rem', fontSize: '0.8rem', color: '#58a6ff' }}>
                            <span>üè≠ {persona.industry}</span>
                            <span>üíº {persona.company_size}</span>
                            <span>üìä {persona.expertise_level}</span>
                        </div>
                    </div>

                    <div style={{ marginBottom: '1rem' }}>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.25rem' }}>
                            {tags.slice(0, 3).map(tag => (
                                <span 
                                    key={tag}
                                    style={{ 
                                        backgroundColor: '#21262d', 
                                        color: '#7d8590', 
                                        padding: '0.25rem 0.5rem', 
                                        borderRadius: '4px',
                                        fontSize: '0.75rem'
                                    }}
                                >
                                    {tag}
                                </span>
                            ))}
                            {tags.length > 3 && (
                                <span style={{ color: '#7d8590', fontSize: '0.75rem' }}>
                                    +{tags.length - 3}
                                </span>
                            )}
                        </div>
                    </div>

                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', gap: '1rem', fontSize: '0.8rem', color: '#7d8590' }}>
                            <span>üîÑ {usage_count}</span>
                            {rating > 0 && <span>‚≠ê {rating}/5</span>}
                        </div>
                        <div 
                            style={{ display: 'flex', gap: '0.5rem' }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <button 
                                onClick={() => onToggleFavorite(id)}
                                style={{ 
                                    background: 'none', 
                                    border: 'none', 
                                    cursor: 'pointer',
                                    fontSize: '1rem',
                                    padding: '0.25rem'
                                }}
                                title={is_favorite ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych'}
                            >
                                {is_favorite ? 'üíñ' : 'ü§ç'}
                            </button>
                            <button 
                                onClick={() => onDelete(id)}
                                style={{ 
                                    background: 'none', 
                                    border: 'none', 
                                    cursor: 'pointer',
                                    fontSize: '1rem',
                                    padding: '0.25rem',
                                    color: '#f85149'
                                }}
                                title="Usu≈Ñ personƒô"
                            >
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ VISUAL FLOW DESIGNER COMPONENT ============
        function VisualFlowDesigner({ setError }) {
            const [activeDesignerTab, setActiveDesignerTab] = React.useState('canvas');
            const [flowData, setFlowData] = React.useState({
                id: '',
                name: 'New Flow',
                description: '',
                avatarType: 'networker',
                nodes: [],
                edges: []
            });
            const [selectedNode, setSelectedNode] = React.useState(null);
            const [nodeModalOpen, setNodeModalOpen] = React.useState(false);
            const [editingNode, setEditingNode] = React.useState(null);
            const svgRef = React.useRef(null);

            // Load templates on mount
            React.useEffect(() => {
                loadTemplates();
            }, []);

            const loadTemplates = async () => {
                setLoadingTemplates(true);
                try {
                    const response = await fetch('/api/flow-wizard/templates');
                    const result = await response.json();
                    if (result.success) {
                        setTemplates(Object.entries(result.data.templates).map(([key, template]) => ({
                            id: key,
                            ...template
                        })));
                    }
                } catch (error) {
                    setError('Failed to load templates: ' + error.message);
                } finally {
                    setLoadingTemplates(false);
                }
            };

            const generateQuickFlow = async (templateId) => {
                setGeneratingFlow(true);
                try {
                    const response = await fetch('/api/flow-wizard/generate-quick', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ template: templateId })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setGeneratedFlow(result.data.flow_package);
                        setActiveWizardTab('result');
                    } else {
                        setError('Failed to generate flow: ' + result.error);
                    }
                } catch (error) {
                    setError('Failed to generate flow: ' + error.message);
                } finally {
                    setGeneratingFlow(false);
                }
            };

            const generateCustomFlow = async () => {
                if (!customFlowData.businessContext || !customFlowData.flowPurpose) {
                    setError('Business context and flow purpose are required');
                    return;
                }

                setGeneratingFlow(true);
                try {
                    const response = await fetch('/api/flow-wizard/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(customFlowData)
                    });
                    const result = await response.json();
                    if (result.success) {
                        setGeneratedFlow(result.data.flow_package);
                        setActiveWizardTab('result');
                    } else {
                        setError('Failed to generate custom flow: ' + result.error);
                    }
                } catch (error) {
                    setError('Failed to generate custom flow: ' + error.message);
                } finally {
                    setGeneratingFlow(false);
                }
            };

            const saveFlowPackage = async () => {
                if (!generatedFlow) return;

                try {
                    const response = await fetch('/api/flow-wizard/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ flowPackage: generatedFlow })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setError('‚úÖ Flow package saved successfully!');
                    } else {
                        setError('Failed to save flow package: ' + result.error);
                    }
                } catch (error) {
                    setError('Failed to save flow package: ' + error.message);
                }
            };

            return React.createElement('div', { 
                className: 'flow-wizard', 
                style: { 
                    padding: '40px', 
                    margin: '20px',
                    backgroundColor: '#f8f9fa', 
                    borderRadius: '12px',
                    minHeight: '80vh'
                } 
            },
                React.createElement('div', { 
                    className: 'wizard-header mb-5 text-center',
                    style: { paddingBottom: '30px' }
                },
                    React.createElement('h2', { 
                        style: { 
                            color: '#2c3e50', 
                            marginBottom: '20px', 
                            fontSize: '36px',
                            fontWeight: 'bold'
                        } 
                    }, 'üßô‚Äç‚ôÇÔ∏è Flow Wizard'),
                    React.createElement('p', { 
                        className: 'text-muted', 
                        style: { 
                            fontSize: '18px', 
                            color: '#6c757d',
                            maxWidth: '600px',
                            margin: '0 auto',
                            lineHeight: '1.6'
                        } 
                    }, 'Automatycznie generuj kompletne flows z intencjami, promptami i knowledge base')
                ),

                // Sub tabs
                React.createElement('div', { 
                    className: 'wizard-tabs mb-5 d-flex justify-content-center', 
                    style: { 
                        gap: '15px',
                        paddingBottom: '40px'
                    } 
                },
                    React.createElement('button', {
                        className: `btn ${activeWizardTab === 'templates' ? 'btn-primary' : 'btn-outline-primary'} btn-lg`,
                        style: { 
                            minWidth: '180px', 
                            fontWeight: 'bold',
                            padding: '12px 24px',
                            fontSize: '16px',
                            borderRadius: '10px'
                        },
                        onClick: () => setActiveWizardTab('templates')
                    }, 'üìã Quick Templates'),
                    React.createElement('button', {
                        className: `btn ${activeWizardTab === 'custom' ? 'btn-primary' : 'btn-outline-primary'} btn-lg`,
                        style: { 
                            minWidth: '180px', 
                            fontWeight: 'bold',
                            padding: '12px 24px',
                            fontSize: '16px',
                            borderRadius: '10px'
                        },
                        onClick: () => setActiveWizardTab('custom')
                    }, 'üé® Custom Flow'),
                    generatedFlow && React.createElement('button', {
                        className: `btn ${activeWizardTab === 'result' ? 'btn-success' : 'btn-outline-success'} btn-lg`,
                        style: { 
                            minWidth: '180px', 
                            fontWeight: 'bold',
                            padding: '12px 24px',
                            fontSize: '16px',
                            borderRadius: '10px'
                        },
                        onClick: () => setActiveWizardTab('result')
                    }, '‚ú® Generated Flow')
                ),

                // Quick Templates Tab
                activeWizardTab === 'templates' && React.createElement('div', { 
                    className: 'templates-tab', 
                    style: { 
                        backgroundColor: 'white', 
                        padding: '40px', 
                        borderRadius: '12px', 
                        border: '1px solid #dee2e6',
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                    } 
                },
                    React.createElement('h4', { 
                        style: { 
                            color: '#495057', 
                            marginBottom: '30px', 
                            textAlign: 'center',
                            fontSize: '24px',
                            fontWeight: 'bold'
                        } 
                    }, 'üìã Gotowe szablony flows'),
                    loadingTemplates && React.createElement('div', { className: 'text-center', style: { padding: '40px' } },
                        React.createElement('div', { className: 'spinner-border text-primary', role: 'status' }),
                        React.createElement('p', { className: 'mt-2' }, '≈Åadowanie szablon√≥w...')
                    ),
                    !loadingTemplates && React.createElement('div', { className: 'row' },
                        templates.map(template => 
                            React.createElement('div', { key: template.id, className: 'col-lg-4 col-md-6 mb-4' },
                                React.createElement('div', { 
                                    className: 'card h-100 shadow-sm',
                                    style: { 
                                        border: '1px solid #e3e6ea', 
                                        borderRadius: '10px',
                                        transition: 'transform 0.2s, box-shadow 0.2s',
                                        cursor: 'pointer'
                                    },
                                    onMouseEnter: (e) => {
                                        e.target.style.transform = 'translateY(-5px)';
                                        e.target.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
                                    },
                                    onMouseLeave: (e) => {
                                        e.target.style.transform = 'translateY(0)';
                                        e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                                    }
                                },
                                    React.createElement('div', { className: 'card-header', style: { backgroundColor: '#f8f9fa', borderBottom: '1px solid #dee2e6' } },
                                        React.createElement('h5', { className: 'card-title mb-0', style: { color: '#495057', fontSize: '18px' } }, 
                                            template.id.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                                        )
                                    ),
                                    React.createElement('div', { className: 'card-body d-flex flex-column' },
                                        React.createElement('p', { className: 'card-text flex-grow-1', style: { color: '#6c757d', lineHeight: '1.5' } }, template.description),
                                        React.createElement('div', { className: 'mb-3' },
                                            React.createElement('div', { className: 'badge bg-secondary me-2 mb-1' }, template.avatarType),
                                            template.useRAG && React.createElement('div', { className: 'badge bg-info' }, 'RAG Enabled')
                                        ),
                                        React.createElement('div', { className: 'small text-muted mb-3', style: { fontSize: '14px' } },
                                            `üìã ${template.businessContext}`
                                        ),
                                        React.createElement('button', {
                                            className: `btn ${generatingFlow ? 'btn-secondary' : 'btn-primary'} w-100`,
                                            style: { 
                                                fontWeight: 'bold',
                                                borderRadius: '6px',
                                                padding: '10px'
                                            },
                                            onClick: () => generateQuickFlow(template.id),
                                            disabled: generatingFlow
                                        }, 
                                            generatingFlow ? 
                                                React.createElement('span', null,
                                                    React.createElement('span', { className: 'spinner-border spinner-border-sm me-2' }),
                                                    'Generating...'
                                                ) : 
                                                'üöÄ Generate Flow'
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),

                // Custom Flow Tab
                activeWizardTab === 'custom' && React.createElement('div', { 
                    className: 'custom-tab',
                    style: { 
                        backgroundColor: 'white', 
                        padding: '50px', 
                        borderRadius: '12px', 
                        border: '1px solid #dee2e6',
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                    }
                },
                    React.createElement('h4', { 
                        style: { 
                            color: '#495057', 
                            marginBottom: '40px', 
                            textAlign: 'center',
                            fontSize: '24px',
                            fontWeight: 'bold'
                        } 
                    }, 'üé® Stw√≥rz w≈Çasny flow'),
                    React.createElement('div', { className: 'row justify-content-center' },
                        React.createElement('div', { className: 'col-lg-10 col-xl-8' },
                            React.createElement('div', { className: 'mb-5' },
                                React.createElement('label', { 
                                    className: 'form-label fw-bold',
                                    style: { 
                                        color: '#495057', 
                                        fontSize: '18px',
                                        marginBottom: '12px',
                                        display: 'block'
                                    }
                                }, 'üè¢ Kontekst biznesowy *'),
                                React.createElement('input', {
                                    type: 'text',
                                    className: 'form-control form-control-lg',
                                    style: { 
                                        borderRadius: '10px',
                                        border: '2px solid #e9ecef',
                                        padding: '16px 20px',
                                        fontSize: '17px',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                        transition: 'border-color 0.3s, box-shadow 0.3s'
                                    },
                                    value: customFlowData.businessContext,
                                    onChange: (e) => setCustomFlowData({...customFlowData, businessContext: e.target.value}),
                                    placeholder: 'np. Sprzeda≈º samochod√≥w premium, Konsultacje IT, Szkolenia biznesowe...'
                                })
                            ),
                            React.createElement('div', { className: 'mb-5' },
                                React.createElement('label', { 
                                    className: 'form-label fw-bold',
                                    style: { 
                                        color: '#495057', 
                                        fontSize: '18px',
                                        marginBottom: '12px',
                                        display: 'block'
                                    }
                                }, 'üéØ Cel flow *'),
                                React.createElement('input', {
                                    type: 'text',
                                    className: 'form-control form-control-lg',
                                    style: { 
                                        borderRadius: '10px',
                                        border: '2px solid #e9ecef',
                                        padding: '16px 20px',
                                        fontSize: '17px',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                                        transition: 'border-color 0.3s, box-shadow 0.3s'
                                    },
                                    value: customFlowData.flowPurpose,
                                    onChange: (e) => setCustomFlowData({...customFlowData, flowPurpose: e.target.value}),
                                    placeholder: 'np. Kwalifikacja klienta i prezentacja modeli, Analiza potrzeb technologicznych...'
                                })
                            ),
                            React.createElement('div', { className: 'row mb-5' },
                                React.createElement('div', { className: 'col-md-6' },
                                    React.createElement('div', { className: 'mb-4' },
                                        React.createElement('label', { 
                                            className: 'form-label fw-bold',
                                            style: { 
                                                color: '#495057', 
                                                fontSize: '18px',
                                                marginBottom: '12px',
                                                display: 'block'
                                            }
                                        }, 'üë§ Typ avatara'),
                                        React.createElement('select', {
                                            className: 'form-select form-select-lg',
                                            style: { 
                                                borderRadius: '10px',
                                                border: '2px solid #e9ecef',
                                                padding: '16px 20px',
                                                fontSize: '17px',
                                                boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                            },
                                            value: customFlowData.avatarType,
                                            onChange: (e) => setCustomFlowData({...customFlowData, avatarType: e.target.value})
                                        },
                                            React.createElement('option', { value: 'networker' }, 'ü§ù Networker'),
                                            React.createElement('option', { value: 'trainer' }, 'üë®‚Äçüè´ Trainer'),
                                            React.createElement('option', { value: 'client' }, 'üë• Client'),
                                            React.createElement('option', { value: 'custom' }, '‚ö° Custom')
                                        )
                                    )
                                ),
                                React.createElement('div', { className: 'col-md-6' },
                                    React.createElement('div', { className: 'mb-4' },
                                        React.createElement('label', { 
                                            className: 'form-label fw-bold',
                                            style: { 
                                                color: '#495057', 
                                                fontSize: '18px',
                                                marginBottom: '12px',
                                                display: 'block'
                                            }
                                        }, 'üß† U≈ºyj RAG'),
                                        React.createElement('div', { 
                                            className: 'form-check',
                                            style: { 
                                                padding: '20px 24px',
                                                backgroundColor: '#f8f9fa',
                                                borderRadius: '10px',
                                                border: '2px solid #e9ecef'
                                            }
                                        },
                                            React.createElement('input', {
                                                className: 'form-check-input',
                                                type: 'checkbox',
                                                style: { transform: 'scale(1.5)', marginTop: '2px' },
                                                checked: customFlowData.useRAG,
                                                onChange: (e) => setCustomFlowData({...customFlowData, useRAG: e.target.checked})
                                            }),
                                            React.createElement('label', { 
                                                className: 'form-check-label ms-3',
                                                style: { fontSize: '16px', color: '#495057', fontWeight: '500' }
                                            },
                                                'üìö Generuj knowledge base'
                                            )
                                        )
                                    )
                                )
                            ),
                            React.createElement('div', { className: 'text-center', style: { paddingTop: '20px' } },
                                React.createElement('button', {
                                    className: `btn btn-lg ${generatingFlow ? 'btn-secondary' : 'btn-success'}`,
                                    style: { 
                                        padding: '20px 50px',
                                        fontSize: '20px',
                                        fontWeight: 'bold',
                                        borderRadius: '12px',
                                        minWidth: '300px',
                                        boxShadow: '0 4px 12px rgba(40, 167, 69, 0.3)',
                                        transition: 'all 0.3s ease'
                                    },
                                    onClick: generateCustomFlow,
                                    disabled: generatingFlow || !customFlowData.businessContext || !customFlowData.flowPurpose
                                }, 
                                    generatingFlow ? 
                                        React.createElement('span', null,
                                            React.createElement('span', { className: 'spinner-border spinner-border-sm me-3' }),
                                            'Generating...'
                                        ) : 
                                        'üöÄ Generate Custom Flow'
                                )
                            )
                        )
                    )
                ),

                // Generated Flow Result Tab
                activeWizardTab === 'result' && generatedFlow && React.createElement('div', { 
                    className: 'result-tab',
                    style: { 
                        backgroundColor: 'white', 
                        padding: '40px', 
                        borderRadius: '12px', 
                        border: '1px solid #dee2e6',
                        boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)'
                    }
                },
                    React.createElement('div', { 
                        className: 'flow-result-header d-flex justify-content-between align-items-center mb-5',
                        style: { paddingBottom: '30px', borderBottom: '2px solid #e9ecef' }
                    },
                        React.createElement('h4', { 
                            style: { 
                                color: '#28a745', 
                                marginBottom: '0', 
                                fontSize: '28px',
                                fontWeight: 'bold'
                            }
                        }, `‚ú® ${generatedFlow.name}`),
                        React.createElement('button', {
                            className: 'btn btn-success btn-lg',
                            style: { 
                                fontWeight: 'bold',
                                borderRadius: '8px',
                                padding: '10px 25px'
                            },
                            onClick: saveFlowPackage
                        }, 'üíæ Save to Files')
                    ),
                    
                    React.createElement('div', { className: 'row' },
                        // Flow Definition
                        React.createElement('div', { className: 'col-md-6 mb-4' },
                            React.createElement('div', { 
                                className: 'card h-100 shadow-sm',
                                style: { borderRadius: '10px', border: '1px solid #e3e6ea' }
                            },
                                React.createElement('div', { 
                                    className: 'card-header',
                                    style: { backgroundColor: '#f8f9fa', borderBottom: '1px solid #dee2e6' }
                                },
                                    React.createElement('h5', { 
                                        className: 'mb-0',
                                        style: { color: '#495057', fontSize: '18px' }
                                    }, 'üîÑ Flow Definition')
                                ),
                                React.createElement('div', { className: 'card-body' },
                                    React.createElement('div', { className: 'mb-3' },
                                        React.createElement('span', { className: 'badge bg-primary fs-6' }, 
                                            `${generatedFlow.flow_definition.steps.length} Steps`
                                        )
                                    ),
                                    React.createElement('div', { className: 'list-group list-group-flush' },
                                        generatedFlow.flow_definition.steps.map((step, index) =>
                                            React.createElement('div', { 
                                                key: step.id, 
                                                className: 'list-group-item px-0',
                                                style: { border: 'none', fontSize: '14px' }
                                            },
                                                React.createElement('strong', null, `${index + 1}. `),
                                                step.name
                                            )
                                        )
                                    )
                                )
                            )
                        ),

                        // Intents
                        React.createElement('div', { className: 'col-md-6 mb-4' },
                            React.createElement('div', { 
                                className: 'card h-100 shadow-sm',
                                style: { borderRadius: '10px', border: '1px solid #e3e6ea' }
                            },
                                React.createElement('div', { 
                                    className: 'card-header',
                                    style: { backgroundColor: '#f8f9fa', borderBottom: '1px solid #dee2e6' }
                                },
                                    React.createElement('h5', { 
                                        className: 'mb-0',
                                        style: { color: '#495057', fontSize: '18px' }
                                    }, 'üéØ Intents')
                                ),
                                React.createElement('div', { className: 'card-body' },
                                    React.createElement('div', { className: 'mb-3' },
                                        React.createElement('span', { className: 'badge bg-info fs-6' }, 
                                            `${generatedFlow.intent_definitions.length} Intents`
                                        )
                                    ),
                                    React.createElement('div', { className: 'list-group list-group-flush' },
                                        generatedFlow.intent_definitions.map(intent =>
                                            React.createElement('div', { 
                                                key: intent.name, 
                                                className: 'list-group-item px-0',
                                                style: { border: 'none', fontSize: '14px' }
                                            },
                                                `‚Ä¢ ${intent.name}`
                                            )
                                        )
                                    )
                                )
                            )
                        ),

                        // Prompts
                        React.createElement('div', { className: 'col-md-6 mb-4' },
                            React.createElement('div', { 
                                className: 'card h-100 shadow-sm',
                                style: { borderRadius: '10px', border: '1px solid #e3e6ea' }
                            },
                                React.createElement('div', { 
                                    className: 'card-header',
                                    style: { backgroundColor: '#f8f9fa', borderBottom: '1px solid #dee2e6' }
                                },
                                    React.createElement('h5', { 
                                        className: 'mb-0',
                                        style: { color: '#495057', fontSize: '18px' }
                                    }, 'üí¨ Prompts')
                                ),
                                React.createElement('div', { className: 'card-body' },
                                    React.createElement('div', { className: 'mb-3' },
                                        React.createElement('span', { className: 'badge bg-warning fs-6' }, 
                                            `${generatedFlow.prompt_templates.length} Templates`
                                        )
                                    ),
                                    React.createElement('div', { className: 'list-group list-group-flush' },
                                        generatedFlow.prompt_templates.map(prompt =>
                                            React.createElement('div', { 
                                                key: prompt.id, 
                                                className: 'list-group-item px-0',
                                                style: { border: 'none', fontSize: '14px' }
                                            },
                                                `‚Ä¢ ${prompt.name}`
                                            )
                                        )
                                    )
                                )
                            )
                        ),

                        // Knowledge Base
                        generatedFlow.knowledge_base && React.createElement('div', { className: 'col-md-6 mb-4' },
                            React.createElement('div', { 
                                className: 'card h-100 shadow-sm',
                                style: { borderRadius: '10px', border: '1px solid #e3e6ea' }
                            },
                                React.createElement('div', { 
                                    className: 'card-header',
                                    style: { backgroundColor: '#f8f9fa', borderBottom: '1px solid #dee2e6' }
                                },
                                    React.createElement('h5', { 
                                        className: 'mb-0',
                                        style: { color: '#495057', fontSize: '18px' }
                                    }, 'üìö Knowledge Base')
                                ),
                                React.createElement('div', { className: 'card-body' },
                                    React.createElement('div', { className: 'mb-3' },
                                        React.createElement('span', { className: 'badge bg-success fs-6' }, 
                                            generatedFlow.knowledge_base.industry
                                        )
                                    ),
                                    React.createElement('div', { className: 'list-group list-group-flush' },
                                        Object.keys(generatedFlow.knowledge_base.knowledge_areas).map(area =>
                                            React.createElement('div', { 
                                                key: area, 
                                                className: 'list-group-item px-0',
                                                style: { border: 'none', fontSize: '14px' }
                                            },
                                                `‚Ä¢ ${area.replace(/_/g, ' ')}`
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),

                    // Integration Instructions
                    React.createElement('div', { 
                        className: 'card mt-4 shadow-sm',
                        style: { borderRadius: '10px', border: '1px solid #e3e6ea' }
                    },
                        React.createElement('div', { 
                            className: 'card-header',
                            style: { backgroundColor: '#f8f9fa', borderBottom: '1px solid #dee2e6' }
                        },
                            React.createElement('h5', { 
                                className: 'mb-0',
                                style: { color: '#495057', fontSize: '18px' }
                            }, 'üìã Integration Instructions')
                        ),
                        React.createElement('div', { className: 'card-body' },
                            React.createElement('ol', { style: { fontSize: '15px', lineHeight: '1.6' } },
                                generatedFlow.integration_instructions.map((instruction, index) =>
                                    React.createElement('li', { 
                                        key: index,
                                        style: { marginBottom: '8px', color: '#495057' }
                                    }, instruction)
                                )
                            )
                        )
                    )
                )
            );
        }

        // ============ CUSTOM SCENARIO CREATOR COMPONENT ============
        function CustomScenarioCreator({ personas, onScenarioCreated, setError }) {
            const [scenarioData, setScenarioData] = useState({
                name: '',
                description: '',
                goals: [''],
                participants: []
            });
            const [draggedPersona, setDraggedPersona] = useState(null);

            const addParticipant = (persona, role) => {
                const newParticipant = {
                    id: `participant_${Date.now()}`,
                    personaId: persona.id,
                    persona: persona.persona,
                    role: role,
                    avatarType: 'networker'
                };

                setScenarioData(prev => ({
                    ...prev,
                    participants: [...prev.participants, newParticipant]
                }));
            };

            const removeParticipant = (participantId) => {
                setScenarioData(prev => ({
                    ...prev,
                    participants: prev.participants.filter(p => p.id !== participantId)
                }));
            };

            const handleDrop = (e, role) => {
                e.preventDefault();
                if (draggedPersona) {
                    addParticipant(draggedPersona, role);
                    setDraggedPersona(null);
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
            };

            const addGoal = () => {
                setScenarioData(prev => ({
                    ...prev,
                    goals: [...prev.goals, '']
                }));
            };

            const updateGoal = (index, value) => {
                setScenarioData(prev => ({
                    ...prev,
                    goals: prev.goals.map((goal, i) => i === index ? value : goal)
                }));
            };

            const removeGoal = (index) => {
                setScenarioData(prev => ({
                    ...prev,
                    goals: prev.goals.filter((_, i) => i !== index)
                }));
            };

            const createScenario = () => {
                if (scenarioData.participants.length < 2) {
                    setError('Scenariusz musi mieƒá przynajmniej 2 uczestnik√≥w');
                    return;
                }

                const customScenario = {
                    id: `custom_${Date.now()}`,
                    name: scenarioData.name || 'W≈Çasny Scenariusz',
                    description: scenarioData.description,
                    participants: scenarioData.participants.map(p => ({
                        id: p.id,
                        avatarType: p.avatarType,
                        role: p.role,
                        persona: p.persona
                    })),
                    success_metrics: scenarioData.goals.filter(g => g.trim()),
                    type: 'custom'
                };

                onScenarioCreated(customScenario);
                alert('‚úÖ Scenariusz zosta≈Ç utworzony! Mo≈ºesz go teraz uruchomiƒá w zak≈Çadce "Nowa Symulacja".');
            };

            return (
                <div className="custom-scenario-creator">
                    <h2>üé® Kreator W≈Çasnego Scenariusza</h2>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '2rem' }}>
                        {/* Lewa kolumna - Biblioteka Postaci */}
                        <div>
                            <h3>üë• Dostƒôpne Postaci</h3>
                            <div style={{ fontSize: '0.9rem', color: '#7d8590', marginBottom: '1rem' }}>
                                PrzeciƒÖgnij postaci do odpowiednich r√≥l ‚Üí
                            </div>
                            <div style={{ maxHeight: '60vh', overflowY: 'auto' }}>
                                {personas.map(stored => (
                                    <div 
                                        key={stored.id}
                                        draggable
                                        onDragStart={() => setDraggedPersona(stored)}
                                        style={{ 
                                            backgroundColor: '#161b22',
                                            border: '1px solid #30363d',
                                            borderRadius: '8px',
                                            padding: '1rem',
                                            marginBottom: '0.5rem',
                                            cursor: 'grab'
                                        }}
                                        onMouseDown={(e) => e.target.style.cursor = 'grabbing'}
                                        onMouseUp={(e) => e.target.style.cursor = 'grab'}
                                    >
                                        <div style={{ fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                            {stored.persona.name}
                                        </div>
                                        <div style={{ fontSize: '0.8rem', color: '#7d8590' }}>
                                            {stored.persona.industry} ‚Ä¢ {stored.persona.expertise_level}
                                        </div>
                                        <div style={{ display: 'flex', gap: '0.25rem', marginTop: '0.5rem' }}>
                                            {stored.tags.slice(0, 2).map(tag => (
                                                <span 
                                                    key={tag}
                                                    style={{ 
                                                        backgroundColor: '#21262d', 
                                                        color: '#7d8590', 
                                                        padding: '0.125rem 0.25rem', 
                                                        borderRadius: '3px',
                                                        fontSize: '0.7rem'
                                                    }}
                                                >
                                                    {tag}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Prawa kolumna - Konstruktor Scenariusza */}
                        <div>
                            <div style={{ marginBottom: '2rem' }}>
                                <h3>üìã Szczeg√≥≈Çy Scenariusza</h3>
                                <input
                                    type="text"
                                    placeholder="Nazwa scenariusza..."
                                    value={scenarioData.name}
                                    onChange={(e) => setScenarioData(prev => ({...prev, name: e.target.value}))}
                                    style={{ 
                                        width: '100%', 
                                        padding: '0.5rem', 
                                        marginBottom: '1rem',
                                        borderRadius: '6px', 
                                        border: '1px solid #30363d',
                                        backgroundColor: '#21262d',
                                        color: '#e6edf3'
                                    }}
                                />
                                <textarea
                                    placeholder="Opis scenariusza..."
                                    value={scenarioData.description}
                                    onChange={(e) => setScenarioData(prev => ({...prev, description: e.target.value}))}
                                    rows={3}
                                    style={{ 
                                        width: '100%', 
                                        padding: '0.5rem',
                                        borderRadius: '6px', 
                                        border: '1px solid #30363d',
                                        backgroundColor: '#21262d',
                                        color: '#e6edf3',
                                        resize: 'vertical'
                                    }}
                                />
                            </div>

                            <div style={{ marginBottom: '2rem' }}>
                                <h3>üéØ Cele Scenariusza</h3>
                                {scenarioData.goals.map((goal, index) => (
                                    <div key={index} style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                        <input
                                            type="text"
                                            placeholder={`Cel ${index + 1}...`}
                                            value={goal}
                                            onChange={(e) => updateGoal(index, e.target.value)}
                                            style={{ 
                                                flex: 1,
                                                padding: '0.5rem',
                                                borderRadius: '6px', 
                                                border: '1px solid #30363d',
                                                backgroundColor: '#21262d',
                                                color: '#e6edf3'
                                            }}
                                        />
                                        {scenarioData.goals.length > 1 && (
                                            <button 
                                                onClick={() => removeGoal(index)}
                                                style={{ 
                                                    background: 'none', 
                                                    border: 'none', 
                                                    color: '#f85149',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                üóëÔ∏è
                                            </button>
                                        )}
                                    </div>
                                ))}
                                <button onClick={addGoal} className="btn btn-secondary" style={{ fontSize: '0.8rem' }}>
                                    ‚ûï Dodaj cel
                                </button>
                            </div>

                            <div style={{ marginBottom: '2rem' }}>
                                <h3>üé≠ Uczestnicy Scenariusza</h3>
                                
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                    {/* Role Proaktywne */}
                                    <div>
                                        <h4>ü§ù Role Proaktywne</h4>
                                        {['teacher', 'seller', 'interviewer'].map(role => (
                                            <div 
                                                key={role}
                                                onDrop={(e) => handleDrop(e, role)}
                                                onDragOver={handleDragOver}
                                                style={{ 
                                                    minHeight: '80px',
                                                    backgroundColor: '#0d1117',
                                                    border: '2px dashed #30363d',
                                                    borderRadius: '8px',
                                                    padding: '1rem',
                                                    marginBottom: '0.5rem',
                                                    textAlign: 'center',
                                                    color: '#7d8590'
                                                }}
                                            >
                                                <div style={{ fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                    {role === 'teacher' ? 'üéì Trener/Nauczyciel' : 
                                                     role === 'seller' ? 'ü§ù Sprzedawca/Networker' : 
                                                     'üé§ Rekruter'}
                                                </div>
                                                
                                                {scenarioData.participants
                                                    .filter(p => p.role === role)
                                                    .map(participant => (
                                                        <div 
                                                            key={participant.id}
                                                            style={{ 
                                                                backgroundColor: '#161b22',
                                                                border: '1px solid #30363d',
                                                                borderRadius: '6px',
                                                                padding: '0.5rem',
                                                                marginBottom: '0.25rem',
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center'
                                                            }}
                                                        >
                                                            <span style={{ fontSize: '0.8rem' }}>
                                                                {participant.persona.name}
                                                            </span>
                                                            <button 
                                                                onClick={() => removeParticipant(participant.id)}
                                                                style={{ 
                                                                    background: 'none', 
                                                                    border: 'none', 
                                                                    color: '#f85149',
                                                                    cursor: 'pointer'
                                                                }}
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    ))}
                                                
                                                {scenarioData.participants.filter(p => p.role === role).length === 0 && (
                                                    <div style={{ fontSize: '0.8rem' }}>
                                                        PrzeciƒÖgnij postaƒá tutaj
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>

                                    {/* Role Reaktywne */}
                                    <div>
                                        <h4>üë§ Role Reaktywne</h4>
                                        {['learner', 'buyer', 'interviewee'].map(role => (
                                            <div 
                                                key={role}
                                                onDrop={(e) => handleDrop(e, role)}
                                                onDragOver={handleDragOver}
                                                style={{ 
                                                    minHeight: '80px',
                                                    backgroundColor: '#0d1117',
                                                    border: '2px dashed #30363d',
                                                    borderRadius: '8px',
                                                    padding: '1rem',
                                                    marginBottom: '0.5rem',
                                                    textAlign: 'center',
                                                    color: '#7d8590'
                                                }}
                                            >
                                                <div style={{ fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                    {role === 'learner' ? 'üìö Ucze≈Ñ/Student' : 
                                                     role === 'buyer' ? 'üíº Klient/KupujƒÖcy' : 
                                                     'üë§ Kandydat'}
                                                </div>
                                                
                                                {scenarioData.participants
                                                    .filter(p => p.role === role)
                                                    .map(participant => (
                                                        <div 
                                                            key={participant.id}
                                                            style={{ 
                                                                backgroundColor: '#161b22',
                                                                border: '1px solid #30363d',
                                                                borderRadius: '6px',
                                                                padding: '0.5rem',
                                                                marginBottom: '0.25rem',
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center'
                                                            }}
                                                        >
                                                            <span style={{ fontSize: '0.8rem' }}>
                                                                {participant.persona.name}
                                                            </span>
                                                            <button 
                                                                onClick={() => removeParticipant(participant.id)}
                                                                style={{ 
                                                                    background: 'none', 
                                                                    border: 'none', 
                                                                    color: '#f85149',
                                                                    cursor: 'pointer'
                                                                }}
                                                            >
                                                                ‚úï
                                                            </button>
                                                        </div>
                                                    ))}
                                                
                                                {scenarioData.participants.filter(p => p.role === role).length === 0 && (
                                                    <div style={{ fontSize: '0.8rem' }}>
                                                        PrzeciƒÖgnij postaƒá tutaj
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div style={{ textAlign: 'center' }}>
                                <button 
                                    onClick={createScenario}
                                    className="btn btn-primary"
                                    disabled={scenarioData.participants.length < 2}
                                    style={{ fontSize: '1.1rem', padding: '1rem 2rem' }}
                                >
                                    üöÄ Utw√≥rz Scenariusz
                                </button>
                                {scenarioData.participants.length < 2 && (
                                    <div style={{ marginTop: '0.5rem', fontSize: '0.8rem', color: '#7d8590' }}>
                                        Dodaj przynajmniej 2 uczestnik√≥w
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ PERSONA DETAIL MODAL COMPONENT ============
        function PersonaDetailModal({ persona, onClose, onRefresh }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState(persona.persona);
            const [rating, setRating] = useState(0);

            const handleSave = async () => {
                try {
                    await SimulationAPI.updatePersona(persona.id, editData);
                    await onRefresh();
                    setIsEditing(false);
                    alert('‚úÖ Persona zosta≈Ça zaktualizowana!');
                } catch (err) {
                    alert('‚ùå B≈ÇƒÖd podczas aktualizacji persony');
                }
            };

            const handleRate = async (newRating) => {
                try {
                    await SimulationAPI.ratePersona(persona.id, newRating);
                    await onRefresh();
                    setRating(newRating);
                } catch (err) {
                    alert('‚ùå B≈ÇƒÖd podczas oceniania persony');
                }
            };

            return (
                <div style={{ 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    width: '100%', 
                    height: '100%', 
                    backgroundColor: 'rgba(0,0,0,0.8)', 
                    display: 'flex', 
                    justifyContent: 'center', 
                    alignItems: 'center', 
                    zIndex: 1000 
                }}>
                    <div style={{ 
                        backgroundColor: '#161b22', 
                        border: '1px solid #30363d', 
                        borderRadius: '12px', 
                        padding: '2rem',
                        maxWidth: '800px',
                        width: '90%',
                        maxHeight: '90vh',
                        overflowY: 'auto'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                            <h2>üë§ Szczeg√≥≈Çy Persony</h2>
                            <button onClick={onClose} style={{ 
                                background: 'none', 
                                border: 'none', 
                                fontSize: '1.5rem', 
                                cursor: 'pointer',
                                color: '#7d8590'
                            }}>
                                ‚úï
                            </button>
                        </div>

                        {!isEditing ? (
                            <div>
                                <div style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ color: '#e6edf3', marginBottom: '1rem' }}>{persona.persona.name}</h3>
                                    <p style={{ color: '#7d8590', lineHeight: '1.6', marginBottom: '1rem' }}>
                                        {persona.persona.background}
                                    </p>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                                        <div>
                                            <strong>üè≠ Bran≈ºa:</strong> {persona.persona.industry}
                                        </div>
                                        <div>
                                            <strong>üíº Wielko≈õƒá firmy:</strong> {persona.persona.company_size}
                                        </div>
                                        <div>
                                            <strong>üìä Poziom ekspercki:</strong> {persona.persona.expertise_level}
                                        </div>
                                        <div>
                                            <strong>üéØ Styl komunikacji:</strong> {persona.persona.communication_style}
                                        </div>
                                    </div>

                                    {persona.persona.budget_range && (
                                        <div style={{ marginBottom: '1rem' }}>
                                            <strong>üí∞ Bud≈ºet:</strong> {persona.persona.budget_range}
                                        </div>
                                    )}
                                </div>

                                <div style={{ marginBottom: '2rem' }}>
                                    <h4>üéØ Cele:</h4>
                                    <ul style={{ color: '#7d8590', paddingLeft: '1.5rem' }}>
                                        {persona.persona.goals.map((goal, index) => (
                                            <li key={index} style={{ marginBottom: '0.5rem' }}>{goal}</li>
                                        ))}
                                    </ul>
                                </div>

                                <div style={{ marginBottom: '2rem' }}>
                                    <h4>‚ö†Ô∏è Wyzwania:</h4>
                                    <ul style={{ color: '#7d8590', paddingLeft: '1.5rem' }}>
                                        {persona.persona.challenges.map((challenge, index) => (
                                            <li key={index} style={{ marginBottom: '0.5rem' }}>{challenge}</li>
                                        ))}
                                    </ul>
                                </div>

                                <div style={{ marginBottom: '2rem' }}>
                                    <h4>üß† Cechy osobowo≈õci:</h4>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                        {persona.persona.personality_traits.map((trait, index) => (
                                            <span 
                                                key={index}
                                                style={{ 
                                                    backgroundColor: '#21262d', 
                                                    color: '#58a6ff', 
                                                    padding: '0.5rem 1rem', 
                                                    borderRadius: '6px',
                                                    fontSize: '0.9rem'
                                                }}
                                            >
                                                {trait}
                                            </span>
                                        ))}
                                    </div>
                                </div>

                                <div style={{ marginBottom: '2rem' }}>
                                    <h4>üè∑Ô∏è Tagi:</h4>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                        {persona.tags.map((tag, index) => (
                                            <span 
                                                key={index}
                                                style={{ 
                                                    backgroundColor: '#0d1117', 
                                                    color: '#7d8590', 
                                                    padding: '0.25rem 0.75rem', 
                                                    borderRadius: '4px',
                                                    fontSize: '0.8rem',
                                                    border: '1px solid #30363d'
                                                }}
                                            >
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>

                                <div style={{ marginBottom: '2rem' }}>
                                    <h4>‚≠ê Oce≈Ñ tƒô personƒô:</h4>
                                    <div style={{ display: 'flex', gap: '0.5rem' }}>
                                        {[1, 2, 3, 4, 5].map(star => (
                                            <button
                                                key={star}
                                                onClick={() => handleRate(star)}
                                                style={{ 
                                                    background: 'none', 
                                                    border: 'none', 
                                                    fontSize: '1.5rem',
                                                    cursor: 'pointer',
                                                    color: star <= (rating || persona.rating) ? '#ffd700' : '#30363d'
                                                }}
                                            >
                                                ‚≠ê
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div style={{ display: 'flex', gap: '1rem' }}>
                                    <button className="btn btn-secondary" onClick={() => setIsEditing(true)}>
                                        ‚úèÔ∏è Edytuj
                                    </button>
                                    <button className="btn btn-primary" onClick={onClose}>
                                        ‚úì Zamknij
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem' }}>Nazwa:</label>
                                    <input
                                        type="text"
                                        value={editData.name}
                                        onChange={(e) => setEditData({...editData, name: e.target.value})}
                                        style={{ 
                                            width: '100%', 
                                            padding: '0.5rem', 
                                            borderRadius: '6px', 
                                            border: '1px solid #30363d',
                                            backgroundColor: '#21262d',
                                            color: '#e6edf3'
                                        }}
                                    />
                                </div>

                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.5rem' }}>Opis:</label>
                                    <textarea
                                        value={editData.background}
                                        onChange={(e) => setEditData({...editData, background: e.target.value})}
                                        rows={4}
                                        style={{ 
                                            width: '100%', 
                                            padding: '0.5rem', 
                                            borderRadius: '6px', 
                                            border: '1px solid #30363d',
                                            backgroundColor: '#21262d',
                                            color: '#e6edf3',
                                            resize: 'vertical'
                                        }}
                                    />
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '0.5rem' }}>Bran≈ºa:</label>
                                        <input
                                            type="text"
                                            value={editData.industry}
                                            onChange={(e) => setEditData({...editData, industry: e.target.value})}
                                            style={{ 
                                                width: '100%', 
                                                padding: '0.5rem', 
                                                borderRadius: '6px', 
                                                border: '1px solid #30363d',
                                                backgroundColor: '#21262d',
                                                color: '#e6edf3'
                                            }}
                                        />
                                    </div>
                                    <div>
                                        <label style={{ display: 'block', marginBottom: '0.5rem' }}>Wielko≈õƒá firmy:</label>
                                        <input
                                            type="text"
                                            value={editData.company_size}
                                            onChange={(e) => setEditData({...editData, company_size: e.target.value})}
                                            style={{ 
                                                width: '100%', 
                                                padding: '0.5rem', 
                                                borderRadius: '6px', 
                                                border: '1px solid #30363d',
                                                backgroundColor: '#21262d',
                                                color: '#e6edf3'
                                            }}
                                        />
                                    </div>
                                </div>

                                <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
                                    <button className="btn btn-secondary" onClick={() => setIsEditing(false)}>
                                        Anuluj
                                    </button>
                                    <button className="btn btn-primary" onClick={handleSave}>
                                        üíæ Zapisz
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Simulation Creator Component
        function SimulationCreator({ onSimulationCreated, isLoading, setIsLoading, setError }) {
            const [scenarios, setScenarios] = useState([]);
            const [selectedScenario, setSelectedScenario] = useState(null);
            const [config, setConfig] = useState({
                auto_start: true,
                turn_timeout_seconds: 30,
                max_message_length: 1000,
                enable_real_time_analysis: true,
                save_to_database: true,
                export_format: 'json',
                analysis_depth: 'detailed'
            });

            useEffect(() => {
                loadScenarioTemplates();
            }, []);

            const loadScenarioTemplates = async () => {
                try {
                    const result = await SimulationAPI.getScenarioTemplates();
                    if (result.success) {
                        setScenarios(result.data.templates);
                    }
                } catch (err) {
                    console.error('Error loading scenarios:', err);
                }
            };

            const handleCreateSimulation = async () => {
                if (!selectedScenario) {
                    setError('Wybierz scenariusz symulacji');
                    return;
                }

                setIsLoading(true);
                setError(null);

                try {
                    const result = await SimulationAPI.createSimulation(selectedScenario, config);
                    if (result.success) {
                        onSimulationCreated({
                            id: result.data.simulation_id,
                            name: selectedScenario.name,
                            status: result.data.status,
                            participants_count: result.data.participants_count
                        });
                    } else {
                        setError(result.error || 'B≈ÇƒÖd podczas tworzenia symulacji');
                    }
                } catch (err) {
                    setError('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem');
                    console.error('Error creating simulation:', err);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="simulation-grid">
                    <div className="panel">
                        <h2>üìã Wybierz Scenariusz</h2>
                        <div>
                            {scenarios.map((scenario, index) => (
                                <div 
                                    key={index}
                                    className={`scenario-template ${selectedScenario === scenario ? 'selected' : ''}`}
                                    onClick={() => setSelectedScenario(scenario)}
                                >
                                    <div className="scenario-title">{scenario.name}</div>
                                    <div className="scenario-description">{scenario.description}</div>
                                    <div className="scenario-meta">
                                        <span>‚è±Ô∏è {scenario.duration_minutes} min</span>
                                        <span>üë• {scenario.participants?.length || 2} uczestnik√≥w</span>
                                        <span>üè¢ {scenario.context?.industry}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="panel">
                        <h2>‚öôÔ∏è Konfiguracja</h2>
                        
                        <div className="form-group">
                            <label>
                                <input 
                                    type="checkbox" 
                                    checked={config.auto_start}
                                    onChange={(e) => setConfig(prev => ({ ...prev, auto_start: e.target.checked }))}
                                    style={{ marginRight: '0.5rem' }}
                                />
                                Automatyczne rozpoczƒôcie
                            </label>
                        </div>

                        <div className="form-group">
                            <label>Timeout tury (sekundy)</label>
                            <input 
                                type="number" 
                                className="form-control"
                                value={config.turn_timeout_seconds}
                                onChange={(e) => setConfig(prev => ({ ...prev, turn_timeout_seconds: parseInt(e.target.value) }))}
                                min="10"
                                max="300"
                            />
                        </div>

                        <div className="form-group">
                            <label>Maksymalna d≈Çugo≈õƒá wiadomo≈õci</label>
                            <input 
                                type="number" 
                                className="form-control"
                                value={config.max_message_length}
                                onChange={(e) => setConfig(prev => ({ ...prev, max_message_length: parseInt(e.target.value) }))}
                                min="100"
                                max="2000"
                            />
                        </div>

                        <div className="form-group">
                            <label>G≈Çƒôboko≈õƒá analizy</label>
                            <select 
                                className="form-control"
                                value={config.analysis_depth}
                                onChange={(e) => setConfig(prev => ({ ...prev, analysis_depth: e.target.value }))}
                            >
                                <option value="basic">Podstawowa</option>
                                <option value="detailed">Szczeg√≥≈Çowa</option>
                                <option value="comprehensive">Kompleksowa</option>
                            </select>
                        </div>

                        <div className="form-group">
                            <label>
                                <input 
                                    type="checkbox" 
                                    checked={config.enable_real_time_analysis}
                                    onChange={(e) => setConfig(prev => ({ ...prev, enable_real_time_analysis: e.target.checked }))}
                                    style={{ marginRight: '0.5rem' }}
                                />
                                Analiza w czasie rzeczywistym
                            </label>
                        </div>

                        <button 
                            className="btn btn-primary"
                            onClick={handleCreateSimulation}
                            disabled={!selectedScenario || isLoading}
                            style={{ width: '100%', marginTop: '1rem' }}
                        >
                            {isLoading ? (
                                <>
                                    <span className="loading-spinner"></span>
                                    Tworzenie...
                                </>
                            ) : (
                                <>
                                    üöÄ Rozpocznij Symulacjƒô
                                </>
                            )}
                        </button>
                    </div>

                    {selectedScenario && (
                        <div className="panel full-width">
                            <h2>üë• Uczestnicy Scenariusza</h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem' }}>
                                {selectedScenario.participants?.map((participant, index) => (
                                    <div key={index} className="participant-card">
                                        <div className="participant-header">
                                            <span className="participant-name">{participant.persona?.name}</span>
                                            <span className="participant-role">{participant.role}</span>
                                        </div>
                                        <div style={{ fontSize: '0.875rem', color: '#7d8590', marginBottom: '0.5rem' }}>
                                            {participant.persona?.background}
                                        </div>
                                        <div style={{ fontSize: '0.75rem', color: '#7d8590' }}>
                                            {participant.avatarType} ‚Ä¢ {participant.persona?.expertise_level}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Simulation Monitor Component
        function SimulationMonitor({ simulations, selectedSimulation, setSelectedSimulation, onRefresh }) {
            const [currentSimulation, setCurrentSimulation] = useState(null);
            const [messages, setMessages] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (selectedSimulation) {
                    loadSimulationDetails(selectedSimulation);
                }
            }, [selectedSimulation]);

            useEffect(() => {
                if (messagesEndRef.current) {
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages]);

            const loadSimulationDetails = async (simulationId) => {
                setIsLoading(true);
                try {
                    const [simResult, messagesResult] = await Promise.all([
                        SimulationAPI.getSimulation(simulationId),
                        SimulationAPI.getSimulationMessages(simulationId)
                    ]);

                    if (simResult.success) {
                        setCurrentSimulation(simResult.data);
                    }

                    if (messagesResult.success) {
                        setMessages(messagesResult.data.messages);
                    }
                } catch (err) {
                    console.error('Error loading simulation details:', err);
                } finally {
                    setIsLoading(false);
                }
            };

            const handlePauseResume = async () => {
                if (!currentSimulation) return;

                try {
                    if (currentSimulation.status === 'running') {
                        await SimulationAPI.pauseSimulation(currentSimulation.id);
                    } else if (currentSimulation.status === 'paused') {
                        await SimulationAPI.resumeSimulation(currentSimulation.id, {});
                    }
                    
                    await loadSimulationDetails(currentSimulation.id);
                    onRefresh();
                } catch (err) {
                    console.error('Error controlling simulation:', err);
                }
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'running': return '‚ñ∂Ô∏è';
                    case 'paused': return '‚è∏Ô∏è';
                    case 'completed': return '‚úÖ';
                    case 'failed': return '‚ùå';
                    default: return '‚ö™';
                }
            };

            const formatTime = (timestamp) => {
                return new Date(timestamp).toLocaleTimeString('pl-PL');
            };

            return (
                <div className="simulation-grid">
                    <div className="panel">
                        <h2>üìä Aktywne Symulacje</h2>
                        
                        <button 
                            className="btn btn-secondary"
                            onClick={onRefresh}
                            style={{ marginBottom: '1rem', width: '100%' }}
                        >
                            üîÑ Od≈õwie≈º
                        </button>

                        {simulations.map((sim) => (
                            <div 
                                key={sim.id}
                                className={`scenario-template ${selectedSimulation === sim.id ? 'selected' : ''}`}
                                onClick={() => setSelectedSimulation(sim.id)}
                            >
                                <div className="scenario-title">
                                    {getStatusIcon(sim.status)} {sim.name}
                                </div>
                                <div className="scenario-description">
                                    Tura {sim.current_turn}/{sim.max_turns} ‚Ä¢ {sim.participants_count} uczestnik√≥w
                                </div>
                                <div className="scenario-meta">
                                    <span>üìä {sim.quality_score}% jako≈õci</span>
                                    <span>‚è±Ô∏è {formatTime(sim.start_time)}</span>
                                </div>
                                <div className="progress-bar">
                                    <div 
                                        className="progress-fill" 
                                        style={{ width: `${sim.progress_percentage}%` }}
                                    ></div>
                                </div>
                            </div>
                        ))}

                        {simulations.length === 0 && (
                            <div className="text-center" style={{ color: '#7d8590', padding: '2rem' }}>
                                Brak aktywnych symulacji
                            </div>
                        )}
                    </div>

                    <div className="panel">
                        <h2>üí¨ Konwersacja</h2>
                        
                        {currentSimulation && (
                            <>
                                <div className={`simulation-status status-${currentSimulation.status}`}>
                                    {getStatusIcon(currentSimulation.status)} {currentSimulation.status.toUpperCase()}
                                </div>

                                <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                                    {currentSimulation.status === 'running' && (
                                        <button className="btn btn-secondary" onClick={handlePauseResume}>
                                            ‚è∏Ô∏è Pauzuj
                                        </button>
                                    )}
                                    {currentSimulation.status === 'paused' && (
                                        <button className="btn btn-primary" onClick={handlePauseResume}>
                                            ‚ñ∂Ô∏è Wzn√≥w
                                        </button>
                                    )}
                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => loadSimulationDetails(currentSimulation.id)}
                                    >
                                        üîÑ Od≈õwie≈º
                                    </button>
                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => SimulationAPI.exportSimulation(currentSimulation.id, 'json')}
                                    >
                                        üìÑ Eksportuj JSON
                                    </button>
                                    <button 
                                        className="btn btn-secondary" 
                                        onClick={() => SimulationAPI.exportSimulation(currentSimulation.id, 'csv')}
                                    >
                                        üìä Eksportuj CSV
                                    </button>
                                </div>
                            </>
                        )}

                        <div className="message-list">
                            {isLoading ? (
                                <div className="text-center">
                                    <span className="loading-spinner"></span> ≈Åadowanie...
                                </div>
                            ) : messages.length > 0 ? (
                                messages.map((message, index) => (
                                    <div 
                                        key={message.id} 
                                        className={`message participant-${(index % 2) + 1}`}
                                    >
                                        <div className="message-header">
                                            <span className="message-author">
                                                {message.participant_name} ({message.participant_role})
                                            </span>
                                            <span className="message-time">
                                                {formatTime(message.timestamp)}
                                            </span>
                                        </div>
                                        <div className="message-content">
                                            {message.content}
                                        </div>
                                        {message.intent && (
                                            <div style={{ fontSize: '0.75rem', color: '#7d8590', marginTop: '0.5rem' }}>
                                                üí≠ {message.intent}
                                            </div>
                                        )}
                                    </div>
                                ))
                            ) : (
                                <div className="text-center" style={{ color: '#7d8590' }}>
                                    {selectedSimulation ? 'Brak wiadomo≈õci' : 'Wybierz symulacjƒô'}
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>
                </div>
            );
        }

        // Simulation Analysis Component
        function SimulationAnalysis({ simulations, selectedSimulation }) {
            const [analysis, setAnalysis] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            useEffect(() => {
                if (selectedSimulation) {
                    loadAnalysis(selectedSimulation);
                }
            }, [selectedSimulation]);

            const loadAnalysis = async (simulationId) => {
                setIsLoading(true);
                try {
                    const result = await SimulationAPI.getSimulationAnalysis(simulationId);
                    if (result.success) {
                        setAnalysis(result.data);
                    }
                } catch (err) {
                    console.error('Error loading analysis:', err);
                } finally {
                    setIsLoading(false);
                }
            };

            if (!selectedSimulation) {
                return (
                    <div className="panel text-center">
                        <h2>üìà Analiza Symulacji</h2>
                        <p style={{ color: '#7d8590' }}>Wybierz symulacjƒô z listy aby zobaczyƒá analizƒô</p>
                    </div>
                );
            }

            return (
                <div className="simulation-grid">
                    <div className="panel full-width">
                        <h2>üìà Analiza Symulacji</h2>
                        
                        {isLoading ? (
                            <div className="text-center">
                                <span className="loading-spinner"></span> ≈Åadowanie analizy...
                            </div>
                        ) : analysis ? (
                            <>
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <span className="stat-value">{analysis.conversation_quality_score}</span>
                                        <div className="stat-label">Jako≈õƒá konwersacji</div>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">{analysis.conversation_metrics.total_turns}</span>
                                        <div className="stat-label">Liczba tur</div>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">{Math.round(analysis.conversation_metrics.avg_message_length)}</span>
                                        <div className="stat-label">≈örednia d≈Çugo≈õƒá wiadomo≈õci</div>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">{Math.round(analysis.response_times.average)}ms</span>
                                        <div className="stat-label">≈öredni czas odpowiedzi</div>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">{Math.round(analysis.conversation_metrics.topic_consistency * 100)}%</span>
                                        <div className="stat-label">Sp√≥jno≈õƒá tematyczna</div>
                                    </div>
                                    <div className="stat-card">
                                        <span className="stat-value">{Math.round(analysis.conversation_metrics.goal_achievement_rate * 100)}%</span>
                                        <div className="stat-label">OsiƒÖgniƒôcie cel√≥w</div>
                                    </div>
                                </div>

                                {analysis.insights && analysis.insights.length > 0 && (
                                    <div style={{ marginTop: '2rem' }}>
                                        <h3 style={{ color: '#f0f6fc', marginBottom: '1rem' }}>üí° Insights</h3>
                                        <ul style={{ color: '#c9d1d9', paddingLeft: '1.5rem' }}>
                                            {analysis.insights.map((insight, index) => (
                                                <li key={index} style={{ marginBottom: '0.5rem' }}>{insight}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}

                                {analysis.improvement_suggestions && analysis.improvement_suggestions.length > 0 && (
                                    <div style={{ marginTop: '2rem' }}>
                                        <h3 style={{ color: '#f0f6fc', marginBottom: '1rem' }}>üîß Sugestie ulepszenia</h3>
                                        <ul style={{ color: '#c9d1d9', paddingLeft: '1.5rem' }}>
                                            {analysis.improvement_suggestions.map((suggestion, index) => (
                                                <li key={index} style={{ marginBottom: '0.5rem' }}>{suggestion}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                            </>
                        ) : (
                            <div className="text-center" style={{ color: '#7d8590' }}>
                                Brak danych analizy
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render the app
        ReactDOM.render(<SimulationDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
